<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ink Colour Matcher + Predictor (Spectral KM)</title>
  <style>
    :root { --gap: 12px; --radius: 14px; }
    * { box-sizing: border-box; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin:0; padding:24px; background:#0b0c10; color:#e6e6e6; }
    h1 { font-size: 1.25rem; margin: 0 0 8px; }
    .app { max-width: 1200px; margin: 0 auto; display: grid; gap: var(--gap); grid-template-columns: 420px 1fr; align-items: start; }
    .card { background:#111318; border:1px solid #22252e; border-radius: var(--radius); padding:16px; box-shadow: 0 8px 24px rgba(0,0,0,.25); }
    label { display:block; font-size:.85rem; color:#98a2b3; margin-bottom:6px; }
    input, select { width:100%; padding:10px 12px; border-radius:8px; background:#0e1015; border:1px solid #2a2f3a; color:#e6e6e6; }
    input:focus, select:focus { outline: none; border-color:#3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,.2); }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
    .chip { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; background:#0e1015; border:1px solid #2a2f3a; border-radius:9999px; font-size:.8rem; }
    .swatch { width:28px; height:18px; border-radius:6px; border:1px solid #333; display:inline-block; vertical-align:middle; }
    table { width:100%; border-collapse: collapse; font-size:.9rem; }
    th, td { padding:8px 8px; border-bottom:1px solid #1c1f26; }
    th { text-align:left; color:#98a2b3; font-weight:600; }
    .kpi { display:grid; grid-template-columns: repeat(3, 1fr); gap:var(--gap); margin-top:12px; }
    .kpi .card { text-align:center; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .btn { display:inline-flex; align-items:center; justify-content:center; padding:10px 12px; border-radius:8px; border:1px solid #2a2f3a; background:#0e1015; color:#e6e6e6; cursor:pointer; }
    .btn:hover { border-color:#3b82f6; }
    .muted { color:#8a94a6; font-size:.85rem; }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <h1>Ink Colour Matcher + Predictor</h1>
      <div class="row" style="margin-top:12px;">
        <div>
          <label>Search PMS/Name</label>
          <input id="search" placeholder="Type a PMS name (e.g. ‘PANTONE 185 C’) or a colour name..."/>
        </div>
        <div>
          <label>or Enter Target Lab</label>
          <div class="row">
            <input id="L" type="number" step="0.1" placeholder="L*"/>
            <input id="a" type="number" step="0.1" placeholder="a*"/>
            <input id="b" type="number" step="0.1" placeholder="b*"/>
          </div>
        </div>
      </div>

      <div style="margin-top:12px">
        <label>Closest Matches</label>
        <div id="matches" class="muted">Type to see matches…</div>
      </div>

      <div style="margin-top:12px">
        <label>Known Formula (if any)</label>
        <div id="known" class="muted">—</div>
      </div>

      <div class="kpi">
        <div class="card">
          <div class="muted">Target</div>
          <div style="display:flex; align-items:center; gap:8px; justify-content:center; margin-top:6px;">
            <span class="swatch" id="targetSw"></span>
            <span id="targetLabEcho" class="mono"></span>
          </div>
        </div>
        <div class="card">
          <div class="muted">Predicted Mix</div>
          <div style="display:flex; align-items:center; gap:8px; justify-content:center; margin-top:6px;">
            <span class="swatch" id="mixSw"></span>
            <span id="mixLabEcho" class="mono"></span>
          </div>
        </div>
        <div class="card">
          <div class="muted">ΔE00</div>
          <div style="font-size:1.4rem; font-weight:700; margin-top:6px;" id="dE">—</div>
        </div>
      </div>

      <div style="margin-top:12px">
        <label>Max inks to use</label>
        <select id="maxInks">
          <option>2</option>
          <option selected>3</option>
          <option>4</option>
          <option>5</option>
        </select>
      </div>

      <div style="margin-top:12px">
        <button class="btn" id="predict">Suggest Mix</button>
      </div>
    </div>

    <div class="card">
      <h1>Suggested Formula</h1>
      <div id="formula">—</div>
    </div>
  </div>

<script>
// ===== Color math (Lab/XYZ, ΔE00, sRGB) =====
function labToXyz(L,a,b){
  var Yn=100.0, Xn=95.047, Zn=108.883;
  var fy=(L+16)/116.0, fx=fy+a/500.0, fz=fy-b/200.0;
  function finv(t){var t3=t*t*t; return (t3>0.008856)?t3:(t-16/116)/7.787;}
  var xr=finv(fx), yr=finv(fy), zr=finv(fz);
  return [xr*Xn, yr*Yn, zr*Zn];
}
function xyzToLab(X,Y,Z){
  var Yn=100.0, Xn=95.047, Zn=108.883;
  function f(t){ var e=216/24389, k=24389/27; return (t>e)? Math.cbrt(t) : (k*t+16)/116; }
  var xr=X/Xn, yr=Y/Yn, zr=Z/Zn;
  var fx=f(xr), fy=f(yr), fz=f(zr);
  return {L:116*fy-16, a:500*(fx-fy), b:200*(fy-fz)};
}
function labToSrgb(L,a,b){
  var xyz=labToXyz(L,a,b);
  var x=xyz[0]/100, y=xyz[1]/100, z=xyz[2]/100;
  var rl=3.2406*x-1.5372*y-0.4986*z;
  var gl=-0.9689*x+1.8758*y+0.0415*z;
  var bl=0.0557*x-0.2040*y+1.0570*z;
  function comp(u){u=Math.max(0,Math.min(1,u)); return (u<=0.0031308)?12.92*u:1.055*Math.pow(u,1/2.4)-0.055;}
  return {r:Math.round(comp(rl)*255), g:Math.round(comp(gl)*255), b:Math.round(comp(bl)*255)};
}
function hp(x,y){ var h=Math.atan2(y,x)*180/Math.PI; return (h>=0?h:h+360); }
function deltaE2000(l1,l2){
  var L1=l1.L,a1=l1.a,b1=l1.b, L2=l2.L,a2=l2.a,b2=l2.b, d2r=Math.PI/180;
  var avgLp=(L1+L2)/2, C1=Math.hypot(a1,b1), C2=Math.hypot(a2,b2), avgC=(C1+C2)/2;
  var G=0.5*(1-Math.sqrt(Math.pow(avgC,7)/(Math.pow(avgC,7)+Math.pow(25,7))));
  var a1p=(1+G)*a1, a2p=(1+G)*a2, C1p=Math.hypot(a1p,b1), C2p=Math.hypot(a2p,b2), avgCp=(C1p+C2p)/2;
  var h1p=(Math.abs(a1p)<1e-9 && Math.abs(b1)<1e-9)?0:hp(a1p,b1);
  var h2p=(Math.abs(a2p)<1e-9 && Math.abs(b2)<1e-9)?0:hp(a2p,b2);
  var dhp=h2p-h1p; if(dhp>180) dhp-=360; if(dhp<-180) dhp+=360;
  var dLp=L2-L1, dCp=C2p-C1p, dHp=2*Math.sqrt(C1p*C2p)*Math.sin((dhp*d2r)/2);
  var avgHp=h1p+h2p; if(Math.abs(h1p-h2p)>180) avgHp+=360; avgHp/=2;
  var T=1-0.17*Math.cos((avgHp-30)*d2r)+0.24*Math.cos(2*avgHp*d2r)+0.32*Math.cos((3*avgHp+6)*d2r)-0.20*Math.cos((4*avgHp-63)*d2r);
  var Sl=1+0.015*Math.pow(avgLp-50,2)/Math.sqrt(20+Math.pow(avgLp-50,2)), Sc=1+0.045*avgCp, Sh=1+0.015*avgCp*T;
  var Rt=-2*Math.sqrt(Math.pow(avgCp,7)/(Math.pow(avgCp,7)+Math.pow(25,7)))*Math.sin((60*Math.exp(-Math.pow((avgHp-275)/25,2)))*d2r);
  return Math.sqrt(Math.pow(dLp/Sl,2)+Math.pow(dCp/Sc,2)+Math.pow(dHp/Sh,2)+Rt*(dCp/Sc)*(dHp/Sh));
}

// ===== Fixed press laydown (6 BCM) =====
const PRESS = { BCM: 6.0, eta: 0.60, density: 1.00, solids: 0.35, kappa: 1.00 };
function getPressTheta(){
  const Vwet = 1.55 * PRESS.BCM * PRESS.eta;      // mL/m² delivered
  const Wdry = Vwet * PRESS.density * PRESS.solids;// g/m² proxy for thickness
  return PRESS.kappa * Wdry;                       // optical thickness scalar
}

// ===== Spectral KM (finite thickness), assume S(λ)=1, K absorbs cal thickness =====
function R_infty_from_KS(K,S){ const a=(K+S)/S; const b=Math.sqrt(Math.max(0,a*a-1)); return a-b; }
function L_from_KS(K,S){ return Math.sqrt(Math.max(0, K*(K+2*S))); }
function KM_R_over_backing(K,S,X,Rg){
  const Rinf=R_infty_from_KS(K,S); const L=L_from_KS(K,S); const E=Math.exp(2*L*X);
  const num=(Rg-Rinf)/Rinf - Rinf*(Rg-1/Rinf)*E; const den=(Rg-Rinf) - (Rg-1/Rinf)*E;
  let R=num/den; if(!isFinite(R)) R=Rinf; return Math.max(0,Math.min(1,R));
}
// Invert K from reflectance over Abs (Rg=1), with S=1, X=1 (cal thickness folded in)
function invertKfromR(R){
  const S=1, X=1; let lo=1e-6, hi=100;
  function f(K){ return KM_R_over_backing(K,S,X,1.0)-R; }
  let flo=f(lo), fhi=f(hi);
  for(let i=0;i<10 && flo*fhi>0;i++){ hi*=2; fhi=f(hi); }
  if(flo*fhi>0){ return Math.max(1e-6, Math.min(100, (1-R)*(1-R)/(2*R))); }
  for(let i=0;i<40;i++){ const mid=0.5*(lo+hi); const fm=f(mid); if(Math.abs(fm)<1e-8) return mid; if(flo*fm<=0){ hi=mid; fhi=fm; } else { lo=mid; flo=fm; } }
  return 0.5*(lo+hi);
}

// D65/2° CMFs (10 nm 380–730) — compact LUTs
const CMF = {
  wl:[380,390,400,410,420,430,440,450,460,470,480,490,500,510,520,530,540,550,560,570,580,590,600,610,620,630,640,650,660,670,680,690,700,710,720,730],
  x:[0.0014,0.0042,0.0143,0.0435,0.1344,0.2839,0.3483,0.3362,0.2908,0.1954,0.0956,0.0320,0.0049,0.0093,0.0633,0.1655,0.2904,0.4334,0.5945,0.7621,0.9163,1.0263,1.0622,1.0026,0.8544,0.6424,0.4479,0.2835,0.1649,0.0874,0.0468,0.0227,0.0114,0.0058,0.0029,0.0014],
  y:[0.0000,0.0001,0.0004,0.0012,0.0040,0.0116,0.0230,0.0380,0.0600,0.0909,0.1390,0.2080,0.3230,0.5030,0.7100,0.8620,0.9540,0.9950,0.9950,0.9520,0.8700,0.7570,0.6310,0.5030,0.3810,0.2650,0.1750,0.1070,0.0610,0.0320,0.0170,0.0082,0.0041,0.0021,0.0010,0.0005],
  z:[0.0065,0.0201,0.0679,0.2074,0.6456,1.3856,1.7471,1.7721,1.6692,1.2876,0.8130,0.4652,0.2720,0.1582,0.0782,0.0422,0.0203,0.0088,0.0039,0.0021,0.0017,0.0011,0.0008,0.0003,0.0002,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000]
};
const D65=[49.975,52.311,54.648,56.985,59.322,61.659,63.996,66.333,68.669,71.006,73.343,75.680,78.017,80.354,82.690,85.027,87.364,89.701,92.038,94.374,96.711,99.048,101.385,103.722,106.059,108.395,110.732,113.069,115.406,117.743,120.080,122.416,124.753,127.090,129.427,131.764];

function spectrumToLab(R){
  // integrate spectrum → XYZ under D65 2°
  let X=0,Y=0,Z=0, Xw=0,Yw=0,Zw=0;
  for(let i=0;i<CMF.wl.length;i++){
    const I=D65[i];
    X += R[i]*I*CMF.x[i]; Y += R[i]*I*CMF.y[i]; Z += R[i]*I*CMF.z[i];
    Xw+=      I*CMF.x[i]; Yw+=      I*CMF.y[i]; Zw+=      I*CMF.z[i];
  }
  const scale = 100 / Yw; // perfect diffuser → Y=100
  return xyzToLab(X*scale, Y*scale, Z*scale);
}

// ===== State =====
var COLOURS=[], FORMULAS={}, ASSORTMENT={}, SPEC=null;

// ===== Helpers =====
function normaliseName(s){ return String(s||'').trim().toUpperCase().replace(/\s+/g,' '); }
var FORMULAS_NORM={}, COLOUR_TO_FORMULA={};
function buildFormulaIndex(){
  let rows=[];
  if(Array.isArray(FORMULAS)) rows=FORMULAS;
  else if(FORMULAS && typeof FORMULAS==='object'){
    Object.keys(FORMULAS).forEach(k=>{
      if(Array.isArray(FORMULAS[k])) rows.push(...FORMULAS[k]);
      else if(FORMULAS[k] && typeof FORMULAS[k]==='object' && Array.isArray(FORMULAS[k].rows)) rows.push(...FORMULAS[k].rows);
    });
  }
  rows.forEach(r=>{
    const colour = normaliseName(r.Colour||r.color||r.name||'');
    const parts=[];
    for(let i=1;i<=6;i++){
      const ing=r['Ingredient '+i]; const pct=r['%'+(i>1?i:'')];
      if(ing && pct>0) parts.push({ink:ing.trim(), pct:Number(pct)});
    }
    const sum = parts.reduce((a,b)=>a+(b.pct||0),0)||1;
    const norm = parts.map(p=>({ink:p.ink, pct:(p.pct||0)/sum}));
    FORMULAS_NORM[colour]=norm; COLOUR_TO_FORMULA[colour]=norm;
  });
}
function showFormulaFor(colourName){
  const el=document.getElementById('known');
  const key=normaliseName(colourName||''); const f=COLOUR_TO_FORMULA[key];
  if(!f){ el.textContent='—'; return; }
  el.innerHTML=f.map(p=>'<span class="chip"><span class="swatch" style="background:#1f2430"></span>'+p.ink+': <b>'+(p.pct*100).toFixed(1)+'%</b></span>').join(' ');
}
function updateTargetEcho(){
  const L=parseFloat(document.getElementById('L').value||'');
  const a=parseFloat(document.getElementById('a').value||'');
  const b=parseFloat(document.getElementById('b').value||'');
  if(isFinite(L)&&isFinite(a)&&isFinite(b)){
    const rgb=labToSrgb(L,a,b);
    document.getElementById('targetSw').style.background='rgb('+rgb.r+','+rgb.g+','+rgb.b+')';
    document.getElementById('targetLabEcho').textContent='L '+L.toFixed(1)+'  a '+a.toFixed(1)+'  b '+b.toFixed(1);
  }
}
function renderMatches(list){
  const box=document.getElementById('matches');
  if(!list||list.length===0){ box.textContent='No matches'; return; }
  const tbody=document.createElement('div');
  list.slice(0,8).forEach(c=>{
    const rgb=labToSrgb(c.L,c.a,c.b);
    const div=document.createElement('div');
    div.style.display='flex'; div.style.justifyContent='space-between'; div.style.alignItems='center'; div.style.padding='6px 0';
    div.innerHTML='<span class="chip"><span class="swatch" style="background:rgb('+rgb.r+','+rgb.g+','+rgb.b+')"></span>'+c.name+'</span>'+
                  '<span class="mono">L '+c.L.toFixed(1)+' a '+c.a.toFixed(1)+' b '+c.b.toFixed(1)+'</span>';
    div.addEventListener('click', ()=>{ document.getElementById('L').value=c.L; document.getElementById('a').value=c.a; document.getElementById('b').value=c.b; updateTargetEcho(); showFormulaFor(c.name||c.Colour||c.color||''); });
    tbody.appendChild(div);
  });
  box.innerHTML=''; box.appendChild(tbody);
}
function showSuggestion(s){
  const f=document.getElementById('formula');
  if(!s || !s.byInk || s.byInk.length===0){ f.textContent='—'; return; }
  const rows = s.byInk.map(p=>'<tr><td>'+p.ink+'</td><td style="width:120px"><div style="height:10px; background:#1a1d25; border-radius:999px; overflow:hidden;"><div style="height:10px; width:'+(p.weight*100).toFixed(1)+'%; background:#3b82f6"></div></div></td><td class="mono">'+(p.weight*100).toFixed(1)+'%</td></tr>').join('');
  f.innerHTML='<table><thead><tr><th>Ink</th><th>Share</th><th>%</th></tr></thead><tbody>'+rows+'</tbody></table>';
}

// ===== Spectral data handling =====
function buildSpectralKs(ifs){
  const wl = ifs.wavelengths;
  const inks = {};
  for(const c of ifs.colorants){
    const R = c.R.map(v=>Math.max(1e-6, Math.min(0.999999, v)));
    const K = R.map(invertKfromR);
    inks[c.name] = { K };
  }
  return { wl, inks };
}

function predictMixSpectral(targetLab, maxInks, SPECT){
  const wl=SPECT.wl, inks=SPECT.inks;
  const names=Object.keys(inks);
  if(names.length===0) return null;

  // Greedy forward selection with simple simplex reweight
  let chosen=[], weights=[];
  const seed = names.find(n=>/EXTENDER|DC21-00[12]/i.test(n));
  if(seed){ chosen.push(seed); weights.push(1.0); }

  function labFromWeights(ws){
    const theta = getPressTheta();
    const nBand = wl.length;
    const Kmix = new Array(nBand).fill(0);
    let sumW=0;
    for(let i=0;i<chosen.length;i++){
      const Ki = inks[chosen[i]].K;
      const wi = ws[i];
      sumW += wi;
      for(let b=0;b<nBand;b++) Kmix[b] += wi * Ki[b];
    }
    const X = theta * sumW;
    const R = Kmix.map(K => KM_R_over_backing(K,1.0,X,1.0)); // Abs white backing
    return spectrumToLab(R);
  }

  // choose best single if none chosen
  if(chosen.length===0){
    let bestN=null, bestDe=1e9;
    for(const n of names){
      chosen=[n]; weights=[1.0];
      const lab=labFromWeights(weights);
      const de=deltaE2000(lab, targetLab);
      if(de<bestDe){ bestDe=de; bestN=n; }
    }
    chosen=[bestN]; weights=[1.0];
  }

  while(chosen.length<maxInks){
    let bestName=null, bestDe=1e9, bestW=null, baseChosen=chosen.slice(), baseW=weights.slice();
    for(const n of names){
      if(chosen.includes(n)) continue;
      const trialChosen=[...baseChosen, n];
      let ws = new Array(trialChosen.length).fill(1/trialChosen.length);
      // local coordinate descent on simplex
      let step=0.2, bestLocal=1e9, bestWs=ws.slice();
      for(let it=0; it<80; it++){
        let improved=false;
        for(let i=0;i<ws.length;i++){
          for(let j=0;j<ws.length;j++){
            if(i===j) continue;
            const move=Math.min(step, ws[i]);
            if(move<=1e-6) continue;
            const wTry=ws.slice(); wTry[i]-=move; wTry[j]+=move;
            chosen=trialChosen; const L=labFromWeights(wTry); const d=deltaE2000(L, targetLab);
            if(d+1e-9<bestLocal){ bestLocal=d; bestWs=wTry; ws=wTry; improved=true; }
          }
        }
        if(!improved){ step*=0.6; if(step<1e-3) break; }
      }
      if(bestLocal<bestDe){ bestDe=bestLocal; bestName=n; bestW=bestWs; }
      chosen=baseChosen.slice(); weights=baseW.slice();
    }
    if(!bestName) break;
    chosen.push(bestName); weights=bestW;
  }

  const labMix=(function(){ return labFromWeights(weights); })();
  const dE=deltaE2000(labMix, targetLab);
  const result=chosen.map((n,i)=>({ink:n, weight:weights[i]})).sort((a,b)=>b.weight-a.weight);
  const sum=result.reduce((a,b)=>a+b.weight,0)||1; result.forEach(r=>r.weight/=sum);
  const rgb=labToSrgb(labMix.L, labMix.a, labMix.b);
  return { byInk: result, mixLab: labMix, dE, rgb };
}

// ===== Wire-up & data load (UI unchanged) =====
function wireUp(SPECT){
  document.getElementById('search').addEventListener('input', function(){
    const q=normaliseName(this.value||'');
    if(!q){ document.getElementById('matches').textContent='Type to see matches…'; return; }
    const hits = COLOURS.filter(c=>normaliseName(c.name||c.Colour||c.color||'').includes(q));
    renderMatches(hits.slice(0,12));
  });
  ['L','a','b'].forEach(id=>document.getElementById(id).addEventListener('input', updateTargetEcho));
  document.getElementById('predict').addEventListener('click', function(){
    const L=parseFloat(document.getElementById('L').value||'');
    const a=parseFloat(document.getElementById('a').value||'');
    const b=parseFloat(document.getElementById('b').value||'');
    if(!isFinite(L)||!isFinite(a)||!isFinite(b)) return;
    const targetLab={L,a,b};
    const maxInks=parseInt(document.getElementById('maxInks').value||'3',10);
    const res=predictMixSpectral(targetLab, maxInks, SPECT);
    const rgb=res.rgb; document.getElementById('mixSw').style.background='rgb('+rgb.r+','+rgb.g+','+rgb.b+')';
    document.getElementById('mixLabEcho').textContent='L '+res.mixLab.L.toFixed(1)+'  a '+res.mixLab.a.toFixed(1)+'  b '+res.mixLab.b.toFixed(1);
    document.getElementById('dE').textContent=res.dE.toFixed(2);
    showSuggestion(res);
  });
}

Promise.all([
  fetch('colours (1).json').then(r=>r.json()),
  fetch('DC_Formulas (1).json').then(r=>r.json()),
  fetch('assortment_colour_data (1).json').then(r=>r.json()),
  fetch('ifsx_reflectance_abs.json').then(r=>r.json())
]).then(all=>{
  COLOURS=all[0];
  FORMULAS=all[1]; buildFormulaIndex();
  ASSORTMENT=all[2];
  const IFSMODEL=all[3];
  const SPECT=buildSpectralKs(IFSMODEL);
  wireUp(SPECT);
  // preload a demo match
  const demo=COLOURS[0];
  if(demo){
    document.getElementById('search').value=demo.name;
    document.getElementById('search').dispatchEvent(new Event('input'));
    document.getElementById('L').value=demo.L; document.getElementById('a').value=demo.a; document.getElementById('b').value=demo.b;
    updateTargetEcho(); showFormulaFor(demo.name);
  }
});
</script>
</body>
</html>
