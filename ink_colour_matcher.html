<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ink Colour Matcher</title>
  <style>
    :root { --gap: 12px; --radius: 14px; }
    * { box-sizing: border-box; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial; margin: 0; padding: 24px; background: #0b0c10; color: #e6e6e6; }
    h1 { font-size: 1.25rem; margin: 0 0 8px; }
    .app { max-width: 1100px; margin: 0 auto; display: grid; gap: var(--gap); grid-template-columns: 380px 1fr; align-items: start; }
    .card { background: #111318; border: 1px solid #22252e; border-radius: var(--radius); padding: 16px; box-shadow: 0 8px 24px rgba(0,0,0,.25); }
    label { display: block; font-size: .85rem; color: #98a2b3; margin-bottom: 6px; }
    input { width: 100%; padding: 10px 12px; border-radius: 10px; background: #0e1015; border: 1px solid #2a2f3a; color: #e6e6e6; }
    input::placeholder { color: #7b8496; }
    .row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--gap); }
    .row2 { display: grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
    .chip { display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; border:1px solid #2a2f3a; background:#0e1015; font-size:.85rem; }
    .swatch { width: 1.1rem; height: 1.1rem; border-radius: 6px; border: 1px solid rgba(255,255,255,.2); }
    .btn { cursor: pointer; padding:10px 12px; border-radius:10px; border:1px solid #2a2f3a; background:#141824; color:#e6e6e6; font-weight:600; }
    .btn:hover { filter: brightness(1.1); }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 10px; border-bottom: 1px dashed #242938; font-variant-numeric: tabular-nums; }
    th { color: #9aa4b2; font-weight: 600; }
    .result-row { transition: background .2s; cursor:pointer; }
    .result-row:hover { background: rgba(255,255,255,.05); }
    .top { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap: wrap; }
    .pill { font-size:.8rem; color:#98a2b3; }
    .muted { color:#7b8496; font-size:.85rem; }
    fieldset { border: 1px dashed #242938; border-radius: 10px; padding: 10px; }
    legend { font-size:.85rem; color:#9aa4b2; padding: 0 6px; }
    .mode { display:flex; gap:10px; align-items:center; }
    .disabled input { opacity:.5; }
    .formula-box { background:#0e1015; border:1px solid #2a2f3a; border-radius:10px; padding:12px; margin-top:16px; }
    .formula-box h2 { margin-top:0; font-size:1rem; color:#ccc; }
    @media (max-width: 900px) { .app { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <h1>Ink Colour Matcher</h1>
      <p class="pill">Input a colour and find the closest Pantone ink.</p>

      <fieldset>
        <legend>Input Mode</legend>
        <div class="mode">
          <label><input type="radio" name="mode" value="lab" checked> L*a*b*</label>
          <label><input type="radio" name="mode" value="rgb"> RGB</label>
          <label><input type="radio" name="mode" value="hex"> HEX</label>
        </div>
      </fieldset>

      <div id="labGroup" class="row" style="margin-top:12px;">
        <div><label for="L">L*</label><input id="L" type="number" step="0.01" placeholder="e.g. 52.3"></div>
        <div><label for="a">a*</label><input id="a" type="number" step="0.01" placeholder="e.g. 12.8"></div>
        <div><label for="b">b*</label><input id="b" type="number" step="0.01" placeholder="e.g. -4.1"></div>
      </div>

      <div id="rgbGroup" class="row2 disabled" style="margin-top:12px;">
        <div><label for="rgb">RGB (comma)</label><input id="rgb" type="text" placeholder="R,G,B" disabled></div>
        <div class="muted" style="align-self:end;">e.g. 120, 34, 90</div>
      </div>

      <div id="hexGroup" class="row2 disabled" style="margin-top:12px;">
        <div><label for="hex">HEX</label><input id="hex" type="text" placeholder="#RRGGBB" disabled></div>
        <div class="muted" style="align-self:end;">e.g. #1A2B3C</div>
      </div>

      <div style="display:flex; gap:8px; margin-top:12px;">
        <button class="btn" id="findBtn">Find Closest</button>
        <button class="btn" id="clearBtn">Clear</button>
      </div>
    </div>

    <div class="card">
      <div class="top">
        <div class="chip"><span class="swatch" id="targetSwatch"></span> <span id="targetLabel">No input yet</span></div>
        <div class="pill"><span id="countLabel">0</span> colours loaded</div>
      </div>

      <div style="overflow:auto; margin-top:12px; max-height: 60vh;">
        <table id="resultsTable">
          <thead>
            <tr>
              <th>Rank</th><th>Ink</th><th>Distance</th><th>HEX</th><th>RGB</th><th>Lab</th><th>Swatch</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="formulaBox" class="formula-box" style="display:none;">
        <h2 id="formulaTitle"></h2>
        <pre id="formulaContent"></pre>
      </div>
    </div>
  </div>

<script>
let COLOURS = [];
let FORMULAS = [];

// ===== Utility functions =====
const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
function hexToRgb(hex){ hex=(hex||'').replace('#','').trim(); if(hex.length===3)hex=hex.split('').map(c=>c+c).join(''); if(!/^([0-9a-fA-F]{6})$/.test(hex))return null; const i=parseInt(hex,16); return{r:(i>>16)&255,g:(i>>8)&255,b:i&255};}
function rgbStrToRgb(str){const p=(str||'').split(',').map(s=>s.trim()).map(Number); if(p.length!==3||p.some(x=>isNaN(x)))return null; return{r:clamp(Math.round(p[0]),0,255),g:clamp(Math.round(p[1]),0,255),b:clamp(Math.round(p[2]),0,255)};}
function rgbToHex(r,g,b){return '#' + [r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('').toUpperCase();}
function srgbToLab(r,g,b){const sr=[r,g,b].map(v=>v/255).map(c=>c<=0.04045?c/12.92:Math.pow((c+0.055)/1.055,2.4));const X=sr[0]*0.4124564+sr[1]*0.3575761+sr[2]*0.1804375;const Y=sr[0]*0.2126729+sr[1]*0.7151522+sr[2]*0.0721750;const Z=sr[0]*0.0193339+sr[1]*0.1191920+sr[2]*0.9503041;const Xn=0.95047,Yn=1,Zn=1.08883;const fx=f(X/Xn),fy=f(Y/Yn),fz=f(Z/Zn);return{L:116*fy-16,a:500*(fx-fy),b:200*(fy-fz)};function f(t){return t>0.008856?Math.cbrt(t):(7.787*t+16/116);}}
function labToSrgb(L,a,b){const Yn=1,Xn=0.95047,Zn=1.08883;const fy=(L+16)/116;const fx=fy+(a/500);const fz=fy-(b/200);const fx3=fx**3,fy3=fy**3,fz3=fz**3;const X=Xn*(fx3>0.008856?fx3:(fx-16/116)/7.787);const Y=Yn*(fy3>0.008856?fy3:(fy-16/116)/7.787);const Z=Zn*(fz3>0.008856?fz3:(fz-16/116)/7.787);function enc(c){return c<=0.0031308?12.92*c:1.055*Math.pow(c,1/2.4)-0.055;}let r=clamp(Math.round(enc(3.2404542*X-1.5371385*Y-0.4985314*Z)*255),0,255);let g=clamp(Math.round(enc(-0.9692660*X+1.8760108*Y+0.0415560*Z)*255),0,255);let b2=clamp(Math.round(enc(0.0556434*X-0.2040259*Y+1.0572252*Z)*255),0,255);return{r,g,b:b2};}
function deltaE2000(l1,l2){const{L:L1,a:a1,b:b1}=l1,{L:L2,a:a2,b:b2}=l2;const deg2rad=Math.PI/180,rad2deg=180/Math.PI;const avgLp=(L1+L2)/2;const C1=Math.sqrt(a1*a1+b1*b1),C2=Math.sqrt(a2*a2+b2*b2),avgC=(C1+C2)/2;const G=0.5*(1-Math.sqrt((avgC**7)/((avgC**7)+(25**7))));const a1p=(1+G)*a1,a2p=(1+G)*a2;const C1p=Math.sqrt(a1p**2+b1*b1),C2p=Math.sqrt(a2p**2+b2*b2),avgCp=(C1p+C2p)/2;const h1p=hp(a1p,b1),h2p=hp(a2p,b2);let avgHp=Math.abs(h1p-h2p)>180?(h1p+h2p+360)/2:(h1p+h2p)/2;const T=1-0.17*Math.cos((avgHp-30)*deg2rad)+0.24*Math.cos((2*avgHp)*deg2rad)+0.32*Math.cos((3*avgHp+6)*deg2rad)-0.20*Math.cos((4*avgHp-63)*deg2rad);let dHp=h2p-h1p;if(Math.abs(dHp)>180)dHp-=360*Math.sign(dHp);const dLp=L2-L1,dCp=C2p-C1p,dHp_term=2*Math.sqrt(C1p*C2p)*Math.sin((dHp/2)*deg2rad);const Sl=1+(0.015*((avgLp-50)**2))/Math.sqrt(20+((avgLp-50)**2)),Sc=1+0.045*avgCp,Sh=1+0.015*avgCp*T;const deltaTheta=30*Math.exp(-((avgHp-275)/25)**2);const Rc=2*Math.sqrt((avgCp**7)/((avgCp**7)+(25**7)));const Rt=-Rc*Math.sin(2*deltaTheta*deg2rad);return Math.sqrt((dLp/Sl)**2+(dCp/Sc)**2+(dHp_term/Sh)**2+Rt*(dCp/Sc)*(dHp_term/Sh));function hp(a,b){if(a===0&&b===0)return 0;let h=Math.atan2(b,a)*rad2deg;if(h<0)h+=360;return h;}}

// ===== Matching =====
function findClosest(mode,inputs){
  if(!COLOURS.length)return[];
  const list=COLOURS.map(d=>({...d}));
  if(mode==='lab'){
    const L=Number(inputs.L),a=Number(inputs.a),b=Number(inputs.b);
    if([L,a,b].some(x=>isNaN(x)))return[];
    const target={L,a,b};
    return list.map(d=>({...d,score:deltaE2000(target,{L:d.L,a:d.a,b:d.b})}))
               .sort((x,y)=>x.score-y.score);
  }
  if(mode==='rgb'){
    const rgb=rgbStrToRgb(inputs.rgb||''); if(!rgb)return[];
    return list.map(d=>({...d,score:Math.hypot(rgb.r-d.R,rgb.g-d.G,rgb.b-d.B)}))
               .sort((x,y)=>x.score-y.score);
  }
  if(mode==='hex'){
    const rgb=hexToRgb(inputs.hex||''); if(!rgb)return[];
    return list.map(d=>({...d,score:Math.hypot(rgb.r-d.R,rgb.g-d.G,rgb.b-d.B)}))
               .sort((x,y)=>x.score-y.score);
  }
  return[];
}

// ===== UI =====
const $=sel=>document.querySelector(sel);
const tbody=$("#resultsTable tbody");
const sw=$("#targetSwatch");
const formulaBox=$("#formulaBox"),formulaTitle=$("#formulaTitle"),formulaContent=$("#formulaContent");

function renderResults(list){
  tbody.innerHTML="";
  list.slice(0,100).forEach((row,idx)=>{
    const tr=document.createElement("tr");
    tr.className="result-row";
    const hx=row.HEX.startsWith("#")?row.HEX:"#"+row.HEX;
    tr.innerHTML=`<td>${idx+1}</td><td>${row.Pantone}</td><td>${row.score.toFixed(2)}</td>
      <td>${hx}</td><td>${row.R},${row.G},${row.B}</td>
      <td>${row.L.toFixed(2)},${row.a.toFixed(2)},${row.b.toFixed(2)}</td>
      <td><div class='swatch' style='background:${hx}'></div></td>`;
    tr.addEventListener("click",()=>showFormula(row.Pantone));
    tbody.appendChild(tr);
  });
}

function showFormula(name){
  const formula=FORMULAS.find(f=>f.Pantone===name);
  if(!formula){formulaBox.style.display="none";return;}
  formulaBox.style.display="block";
  formulaTitle.textContent=name+" Formula";
  formulaContent.textContent=JSON.stringify(formula.Formula,null,2);
}

function updateTargetEcho(){
  const mode=document.querySelector('input[name="mode"]:checked').value;
  let hex='',label='';
  if(mode==='lab'){
    const L=$("#L").value,a=$("#a").value,b=$("#b").value;
    if([L,a,b].every(v=>v!=='')&&![L,a,b].some(isNaN)){
      const rgb=labToSrgb(Number(L),Number(a),Number(b));
      hex=rgbToHex(rgb.r,rgb.g,rgb.b);
      label=`L*a*b*: ${L},${a},${b} • ${hex}`;
    }
  } else if(mode==='rgb'){
    const rgb=rgbStrToRgb($("#rgb").value);
    if(rgb){hex=rgbToHex(rgb.r,rgb.g,rgb.b);label=`RGB: ${rgb.r},${rgb.g},${rgb.b} • ${hex}`;}
  } else {
    const hx=$("#hex").value.trim();
    const rgb=hexToRgb(hx);
    if(rgb){hex=(hx.startsWith('#')?hx:'#'+hx).toUpperCase();label=`HEX: ${hex}`;}
  }
  sw.style.background=hex||"#0000";
  $("#targetLabel").textContent=label||"No input yet";
}

document.querySelectorAll('input[name="mode"]').forEach(r=>r.addEventListener('change',()=>{
  const m=r.value;
  ["lab","rgb","hex"].forEach(g=>{
    const grp=$("#"+g+"Group");
    const enabled=(g===m);
    grp.classList.toggle('disabled',!enabled);
    grp.querySelectorAll('input').forEach(i=>i.disabled=!enabled);
  });
  updateTargetEcho();
}));

["L","a","b","rgb","hex"].forEach(id=>{
  const el=document.getElementById(id);
  if(el)el.addEventListener("input",updateTargetEcho);
});

$("#findBtn").addEventListener("click",()=>{
  const mode=document.querySelector('input[name="mode"]:checked').value;
  const inputs={L:$("#L").value,a:$("#a").value,b:$("#b").value,rgb:$("#rgb").value,hex:$("#hex").value};
  const results=findClosest(mode,inputs);
  renderResults(results);
  updateTargetEcho();
});
$("#clearBtn").addEventListener("click",()=>{["L","a","b","rgb","hex"].forEach(id=>$("#"+id).value="");tbody.innerHTML="";updateTargetEcho();formulaBox.style.display="none";});

// ===== Load JSON =====
Promise.all([
  fetch('colours.json').then(r=>r.json()),
  fetch('DC_Formulas.json').then(r=>r.json())
]).then(([colours,formulas])=>{
  COLOURS=colours;
  FORMULAS=formulas;
  $("#countLabel").textContent=COLOURS.length;
}).catch(err=>{
  alert("Error loading JSON files: "+err);
});
</script>
</body>
</html>
