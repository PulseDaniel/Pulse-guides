<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ink Colour Matcher — Ladder Mixer (Full Send)</title>
  <style>
    :root { --gap: 12px; --radius: 14px; }
    * { box-sizing: border-box; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin:0; padding:24px; background:#0b0c10; color:#e6e6e6; }
    h1 { font-size: 1.25rem; margin: 0 0 8px; }
    .app { max-width: 1200px; margin: 0 auto; display: grid; gap: var(--gap); grid-template-columns: 420px 1fr; align-items: start; }
    .card { background:#111318; border:1px solid #22252e; border-radius: var(--radius); padding:16px; box-shadow: 0 8px 24px rgba(0,0,0,.25); }
    label { display:block; font-size:.85rem; color:#98a2b3; margin-bottom:6px; }
    input, select { width:100%; padding:10px 12px; border-radius:10px; outline:none; background:#0e1015; border:1px solid #2a2f3a; color:#e6e6e6; }
    input::placeholder { color:#7b8496; }
    .row { display:grid; grid-template-columns:1fr 1fr 1fr; gap:var(--gap); }
    .row2 { display:grid; grid-template-columns:1fr 1fr; gap:var(--gap); }
    .btn { cursor:pointer; padding:10px 12px; border-radius:10px; border:1px solid #2a2f3a; background:#141824; color:#e6e6e6; font-weight:600; }
    .btn:hover { filter:brightness(1.1); }
    table { width:100%; border-collapse:collapse; }
    th, td { text-align:left; padding:10px; border-bottom:1px dashed #242938; font-variant-numeric: tabular-nums; }
    th { color:#9aa4b2; font-weight:600; }
    .result-row { transition: background .2s; cursor:pointer; }
    .result-row:hover { background: rgba(255,255,255,.05); }
    .swatch { width:3.1rem; height:2.1rem; border-radius:6px; border:1px solid rgba(255,255,255,.2); }
    .pill { font-size:.8rem; color:#98a2b3; }
    .muted { color:#7b8496; font-size:.85rem; }
    .formula-box { background:#0e1015; border:1px solid #2a2f3a; border-radius:10px; padding:12px; margin-top:16px; }
    .formula-box h2 { margin:0 0 8px; font-size:1rem; color:#ccc; }
    .formula-grid { display:grid; grid-template-columns: 1fr auto; column-gap: 12px; row-gap: 6px; align-items:center; }
    .fg-ink { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .fg-pct { text-align:right; min-width:4ch; font-variant-numeric: tabular-nums; color:#cbd5e1; }
    .stack { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .flex { display:flex; gap:8px; }
    @media (max-width: 900px) { .app { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="app">
    <!-- Left Column: Target + Controls -->
    <div class="card">
      <div class="top" style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap: wrap;">
        <h1>Ink Colour Matcher</h1>
        <div class="pill"><span id="countLabel">0</span> reference colours</div>
      </div>

      <div class="row" style="margin-top:12px;">
        <div><label for="L">L*</label><input id="L" type="number" step="0.01" placeholder="e.g. 52.30"></div>
        <div><label for="a">a*</label><input id="a" type="number" step="0.01" placeholder="e.g. 12.80"></div>
        <div><label for="b">b*</label><input id="b" type="number" step="0.01" placeholder="e.g. -4.10"></div>
      </div>

      <div class="row2" style="margin-top:12px;">
        <div>
          <label for="pms">Search by PMS (number only)</label>
          <input id="pms" type="text" placeholder="e.g. 186 or 3005"/>
        </div>
        <div style="align-self:end;">
          <button class="btn" id="pmsBtn">Find PMS</button>
        </div>
      </div>

      <div class="flex" style="margin-top:12px;">
        <button class="btn" id="findBtn">Find Closest</button>
        <button class="btn" id="clearBtn">Clear</button>
        <span class="muted" id="statusMsg" aria-live="polite"></span>
      </div>

      <!-- Predictor Controls -->
      <div class="formula-box" id="predictorBox">
        <h2>Suggest Formula (Ladder mixer)</h2>
        <div class="row2" style="margin-bottom:8px;">
          <div>
            <label for="maxInks">Max inks in recipe</label>
            <input id="maxInks" type="number" min="2" max="8" step="1" value="5"/>
          </div>
          <div>
            <label for="mode">Mode</label>
            <select id="mode">
              <option value="fast">Production (fast)</option>
              <option value="full" selected>Full Send (thorough)</option>
            </select>
          </div>
        </div>
        <div class="flex">
          <button class="btn" id="suggestBtn">Suggest Formula</button>
          <div id="predictMsg" class="muted" style="align-self:center;"></div>
        </div>
        <div id="suggestedFormula" class="formula-box" style="display:none;"></div>
      </div>

    </div>

    <!-- Right Column: Results -->
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;">
        <h1>Closest Matches</h1>
        <div class="stack" style="align-items:center;">
          <div class="swatch" id="targetSwatch" title="Target"></div>
          <div class="muted" id="targetEcho">Target: –</div>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th>Colour</th>
            <th>Swatch</th>
            <th>L*</th>
            <th>a*</th>
            <th>b*</th>
            <th>Distance</th>
          </tr>
        </thead>
        <tbody id="resultsTbody"></tbody>
      </table>
      <div id="formulaPanel" class="formula-box" style="display:none;"></div>
    </div>
  </div>

<script>
(function(){
'use strict';
// =========== Helpers ===========
function $(sel){ return document.querySelector(sel); }
function clamp(v, lo, hi){ return Math.min(hi, Math.max(lo, v)); }
function sum(a){ var s=0; for(var i=0;i<a.length;i++) s+=a[i]; return s; }

// Friendly code→name map (display purposes only)
function codeName(code){
  var map={
    'DC21-001':'Extender',
    'DC21-002':'Extender',
    'DC21-304':'Yellow',
    'DC21-201':'Orange',
    'DC21-402':'Green',
    'DC21-604':'Violet',
    'DC21-901':'White',
    'DC21-802':'Black'
  };
  return map[String(code).toUpperCase()]||String(code);
}

// Lab <-> f components (CIE Lab internal)
function labToF(Lab){ var fy=(Lab.L+16)/116; var fx=fy + Lab.a/500; var fz=fy - Lab.b/200; return {fx:fx, fy:fy, fz:fz}; }
function fToLab(f){ return { L: 116*f.fy - 16, a: 500*(f.fx - f.fy), b: 200*(f.fy - f.fz) }; }

// sRGB swatch (assume D65; UI only)
function labToXyzD65(L,a,b){ var Yn=1, Xn=0.95047, Zn=1.08883; var fy=(L+16)/116; var fx=function(f){ return f>0.206893?f*f*f:(f-16/116)/7.787; }; return { X: fx((a/500)+fy)*Xn, Y: fx(fy)*Yn, Z: fx(fy-(b/200))*Zn }; }
function labToSrgb(L,a,b){ var xyz = labToXyzD65(L,a,b); var X=xyz.X, Y=xyz.Y, Z=xyz.Z; var r =  3.2406*X -1.5372*Y -0.4986*Z; var g = -0.9689*X +1.8758*Y +0.0415*Z; var b2= 0.0557*X -0.2040*Y +1.0570*Z; function enc(v){ return v<=0.0031308?12.92*v:1.055*Math.pow(v,1/2.4)-0.055; } return {r:clamp(Math.round(enc(r)*255),0,255), g:clamp(Math.round(enc(g)*255),0,255), b:clamp(Math.round(enc(b2)*255),0,255)}; }

// ΔE2000
function deltaE2000(c1,c2){ var L1=c1.L,a1=c1.a,b1=c1.b, L2=c2.L,a2=c2.a,b2=c2.b; var avgLp=(L1+L2)/2; var C1=Math.hypot(a1,b1), C2=Math.hypot(a2,b2), avgC=(C1+C2)/2; var G=0.5*(1-Math.sqrt(Math.pow(avgC,7)/(Math.pow(avgC,7)+Math.pow(25,7)))); var a1p=(1+G)*a1, a2p=(1+G)*a2; var C1p=Math.hypot(a1p,b1), C2p=Math.hypot(a2p,b2); function hp(x,y){ var h=Math.atan2(y,x)*180/Math.PI; return h>=0?h:h+360; } var h1p=(C1p<1e-7?0:hp(a1p,b1)), h2p=(C2p<1e-7?0:hp(a2p,b2)); var dLp=L2-L1; var dCp=C2p-C1p; var dhp=h2p-h1p; if (C1p*C2p===0) dhp=0; else if (dhp>180) dhp-=360; else if (dhp<-180) dhp+=360; var dHp=2*Math.sqrt(C1p*C2p)*Math.sin((dhp*Math.PI/180)/2); var avgLp2=(avgLp-50)*(avgLp-50); var Sl=1+0.015*avgLp2/Math.sqrt(20+avgLp2); var Sc=1+0.045*avgC; var avgHp=(Math.abs(h1p-h2p)>180)? (h1p+h2p+360)/2 : (h1p+h2p)/2; var T=1-0.17*Math.cos((avgHp-30)*Math.PI/180)+0.24*Math.cos(2*avgHp*Math.PI/180)+0.32*Math.cos(3*avgHp*Math.PI/180+6*Math.PI/180)-0.20*Math.cos(4*avgHp*Math.PI/180-63*Math.PI/180); var Sh=1+0.015*avgC*T; var Rc=2*Math.sqrt(Math.pow(avgC,7)/(Math.pow(avgC,7)+Math.pow(25,7))); var Rt=-Rc*Math.sin(2*(30*Math.exp(-Math.pow((avgHp-275)/25,2)))*Math.PI/180); return Math.sqrt((dLp/Sl)*(dLp/Sl)+(dCp/Sc)*(dCp/Sc)+(dHp/Sh)*(dHp/Sh)+Rt*(dCp/Sc)*(dHp/Sh)); }

// =========== Data holders ===========
var COLOURS=[], FORMULAS={}, ASSORTMENT={};
var FORMULAS_NORM={}, COLOUR_TO_FORMULA={};

function normaliseName(s){ return String(s||'').trim().toUpperCase().replace(/\s+/g,' '); }
function extractPmsNumber(name){ if(!name) return null; var m=String(name).toUpperCase().match(/PANTONE\s*([0-9A-Z]+(?:[\- ]?[0-9A-Z]+)*)/); return m? m[1].replace(/\s+/g,'').replace(/^\-/,''): null; }

function buildFormulaIndex(){ var rows=[]; FORMULAS_NORM={}; COLOUR_TO_FORMULA={}; if(Array.isArray(FORMULAS)){ rows.push.apply(rows, FORMULAS); } else if (FORMULAS && typeof FORMULAS==='object'){ Object.keys(FORMULAS).forEach(function(k){ if(Array.isArray(FORMULAS[k])) rows.push.apply(rows, FORMULAS[k]); else if (FORMULAS[k] && typeof FORMULAS[k]==='object' && Array.isArray(FORMULAS[k].rows)) rows.push.apply(rows, FORMULAS[k].rows); }); } var byColour=new Map(); rows.forEach(function(r){ var cname=r.Colour||r.colour||r.Color||r.color||r.NAME||r.Name; if(!cname) return; var items=[]; for(var i=1;i<=12;i++){ var ink=r['Ingredient '+i]||r['Ink '+i]||r['INGREDIENT '+i]||r['ingredient '+i]; if(!ink) continue; var pct=r['%'+i]||r[i+'%']||r['% '+i]||r['Percent '+i]||r['Percent'+i]||r['%']||''; items.push({ink:ink, percent:pct}); } var arr=byColour.get(cname)||[]; arr.push.apply(arr, items); byColour.set(cname, arr); FORMULAS_NORM[normaliseName(cname)]=arr; }); (COLOURS||[]).forEach(function(c){ var name=c.name||c.Colour||c.color||''; var norm=normaliseName(name); if(FORMULAS_NORM[norm]) { COLOUR_TO_FORMULA[name]=norm; return; } var p=extractPmsNumber(name); if(p){ for (var key in FORMULAS_NORM){ if((extractPmsNumber(key)||'')===p){ COLOUR_TO_FORMULA[name]=normaliseName(key); break; } } } }); }

// =========== UI helpers ===========
function updateTargetEcho(){ var L=parseFloat($('#L').value), a=parseFloat($('#a').value), b=parseFloat($('#b').value); if([L,a,b].some(function(v){return Number.isNaN(v);})){ $('#targetEcho').textContent='Target: –'; $('#targetSwatch').style.background='#0000'; return; } $('#targetEcho').textContent='Target: L '+L.toFixed(2)+' a '+a.toFixed(2)+' b '+b.toFixed(2); var rgb=labToSrgb(L,a,b); $('#targetSwatch').style.background='rgb('+rgb.r+','+rgb.g+','+rgb.b+')'; }
function getTargetLab(){ var L=parseFloat($('#L').value), a=parseFloat($('#a').value), b=parseFloat($('#b').value); if([L,a,b].some(Number.isNaN)) return null; return {L:L,a:a,b:b}; }

// =========== Closest & PMS search ===========
function findClosest(){ var target=getTargetLab(); if(!target){ alert('Enter a valid colour first.'); return; } var rows=COLOURS.map(function(c){ return { raw:c, name:c.name||c.Colour||c.color||'—', L:c.L,a:c.a,b:c.b, de:deltaE2000({L:c.L,a:c.a,b:c.b}, target) }; }).sort(function(a,b){return a.de-b.de;}).slice(0,8); var tbody=$('#resultsTbody'); tbody.innerHTML=''; rows.forEach(function(r){ var tr=document.createElement('tr'); tr.className='result-row'; var rgb=labToSrgb(r.L,r.a,r.b); tr.innerHTML='<td>'+r.name+'</td><td><div class="swatch" style="background: rgb('+rgb.r+','+rgb.g+','+rgb.b+')"></div></td><td>'+r.L.toFixed(2)+'</td><td>'+r.a.toFixed(2)+'</td><td>'+r.b.toFixed(2)+'</td><td>'+r.de.toFixed(2)+'</td>'; tr.addEventListener('click', function(){ showFormulaFor(r.name); }); tbody.appendChild(tr); }); }
function findByPms(){ var qRaw=($('#pms').value||'').trim().toUpperCase(); if(!qRaw){ alert('Enter a PMS number'); return; } var q=qRaw.replace(/^PANTONE\s*/,''); var hits=COLOURS.filter(function(c){ var p=extractPmsNumber(c.name||c.Colour||c.color||''); return p && p.includes(q);}); var tbody=$('#resultsTbody'); tbody.innerHTML=''; if(!hits.length){ alert('No PMS match found'); return; } hits.slice(0,8).forEach(function(c){ var rgb=labToSrgb(c.L,c.a,c.b); var tr=document.createElement('tr'); tr.className='result-row'; tr.innerHTML='<td>'+(c.name||c.Colour||c.color||'—')+'</td><td><div class="swatch" style="background: rgb('+rgb.r+','+rgb.g+','+rgb.b+')"></div></td><td>'+(+c.L).toFixed(2)+'</td><td>'+(+c.a).toFixed(2)+'</td><td>'+(+c.b).toFixed(2)+'</td><td>—</td>'; tr.addEventListener('click', function(){ $('#L').value=c.L; $('#a').value=c.a; $('#b').value=c.b; updateTargetEcho(); findClosest(); showFormulaFor(c.name||c.Colour||c.color||''); }); tbody.appendChild(tr); }); }
function showFormulaFor(colourName){ var panel=$('#formulaPanel'); var list=null; var bound=COLOUR_TO_FORMULA[colourName]; if(bound) list=FORMULAS_NORM[bound]; if(!list) list=FORMULAS_NORM[normaliseName(colourName)]; if(!list){ var want=extractPmsNumber(colourName); if(want){ for (var key in FORMULAS_NORM){ if((extractPmsNumber(key)||'')===want){ list=FORMULAS_NORM[key]; break; } } } } if(!list||!list.length){ panel.style.display='none'; return; } var html='<h2>Existing Formula: '+colourName+'</h2><div class="formula-grid">'; list.forEach(function(item){ var name=item.ink||item.Ink||'Ink'; var pct=item.percent!==''? (item.percent+'%') : ''; html+='<div class="fg-ink">'+name+'</div><div class="fg-pct">'+pct+'</div>'; }); html+='</div>'; panel.innerHTML=html; panel.style.display='block'; }

// =========== Ladder-based ink model ===========
var LADDER = {}; // code -> { white: [ {conc,L,a,b}, ... ] }

function loadAssortmentIntoLadders(){
  LADDER = {};
  for (var code in ASSORTMENT){
    var entry = ASSORTMENT[code];
    if (!entry || !Array.isArray(entry.white) || !entry.white.length) continue;
    var arr = entry.white.map(function(s){ return { conc: +s.conc || +s.Conc || +s.concentration || +s.Percent || +s.pct || 0, L:+s.L, a:+s.a, b:+s.b }; })
                         .filter(function(s){ return s.conc>=0 && isFinite(s.L) && isFinite(s.a) && isFinite(s.b); })
                         .sort(function(a,b){ return a.conc-b.conc; });
    if (arr.length<2) continue;
    LADDER[code] = { white: arr };
  }
}

function labOnLadder(code, conc){
  var row = LADDER[code]; if(!row) return {L:100,a:0,b:0};
  var steps = row.white; if(!steps || steps.length===0) return {L:100,a:0,b:0};
  if (conc<=steps[0].conc) return {L:steps[0].L, a:steps[0].a, b:steps[0].b};
  if (conc>=steps[steps.length-1].conc) { var s=steps[steps.length-1]; return {L:s.L,a:s.a,b:s.b}; }
  for (var i=1;i<steps.length;i++){
    var lo=steps[i-1], hi=steps[i];
    if (conc>=lo.conc && conc<=hi.conc){
      var t = (conc - lo.conc) / Math.max(1e-9, (hi.conc - lo.conc));
      var flo = labToF(lo), fhi = labToF(hi);
      var f = { fx: (1-t)*flo.fx + t*fhi.fx, fy:(1-t)*flo.fy + t*fhi.fy, fz:(1-t)*flo.fz + t*fhi.fz };
      return fToLab(f);
    }
  }
  var s2=steps[steps.length-1]; return {L:s2.L,a:s2.a,b:s2.b};
}

// Extender-aware mixing
function labToLch(Lab){ var C=Math.hypot(Lab.a, Lab.b); var h=Math.atan2(Lab.b, Lab.a); var hdeg=h*180/Math.PI; if(hdeg<0) hdeg+=360; return {L:Lab.L, C:C, h:hdeg}; }
function lchToLab(Lch){ var hr=Lch.h*Math.PI/180; return {L:Lch.L, a:Lch.C*Math.cos(hr), b:Lch.C*Math.sin(hr)}; }

function mixFromLadders(codes, fracs){
  var n=codes.length; if(n===0) return {L:100,a:0,b:0};
  var s=sum(fracs); if (s<=0) return {L:100,a:0,b:0};
  var e=0; var pigmentIdx=[]; var pigmentFr=[];
  for (var i=0;i<n;i++){
    var code=codes[i]; var f=fracs[i];
    if (/\bDC21-002\b|\bDC21-001\b|\bEXTENDER\b/i.test(code)) e+=f; else { pigmentIdx.push(i); pigmentFr.push(f); }
  }
  if (pigmentIdx.length===0){ return {L:95,a:0,b:0}; }
  var sp=sum(pigmentFr); var weights=pigmentFr.map(function(f){ return f/(sp||1); });
  var F={fx:0,fy:0,fz:0};
  for (var k=0;k<pigmentIdx.length;k++){
    var idx=pigmentIdx[k]; var w=weights[k];
    var lab = labOnLadder(codes[idx], w*100);
    var f = labToF(lab);
    F.fx += w*f.fx; F.fy += w*f.fy; F.fz += w*f.fz;
  }
  var base = fToLab(F);
  var kL = 0.55; var kC = 0.70; var ext = clamp(e, 0, 0.95);
  var Lch = labToLch(base);
  var L2  = Lch.L + kL*ext*(100 - Lch.L);
  var C2  = Math.max(0, Lch.C * (1 - kC*ext));
  return lchToLab({L:L2, C:C2, h:Lch.h});
}

// =========== Suggestion engine (ladder-driven) ===========
function getCandidateCodes(){ var list=[]; for (var code in LADDER){ list.push(code); } list.sort(); return list; }
function masstoneLab(code){ return labOnLadder(code, 100); }

function suggestLadderRecipe(target, maxInks, mode){
  var codes = getCandidateCodes(); if (!codes.length) throw new Error('No ladder data available');
  function findCode(re){ for(var i=0;i<codes.length;i++){ var c=codes[i]; if(re.test(c)) return c; } return null; }
  var CODE_EXT = findCode(/\bDC21-002\b|\bDC21-001\b|\bEXTENDER\b/i);
  var CODE_WHT = findCode(/\bDC21-901\b|\bWHITE\b/i);
  var CODE_BLK = findCode(/\bDC21-802\b|\bBLACK\b/i);

  var ranked = codes.map(function(c){ return { code:c, de: deltaE2000(masstoneLab(c), target) }; })
                    .sort(function(a,b){ return a.de-b.de; })
                    .map(function(o){ return o.code; });

  var pool = ranked.slice(0, mode==='full' ? Math.max(40, maxInks+20) : Math.max(12, maxInks+6));
  if (CODE_WHT && pool.indexOf(CODE_WHT)<0) pool.unshift(CODE_WHT);
  if (CODE_EXT && pool.indexOf(CODE_EXT)<0) pool.unshift(CODE_EXT);

  function normalise(fr){ var s=sum(fr); if(s<=0){ var v=1/Math.max(1,fr.length); for(var i=0;i<fr.length;i++) fr[i]=v; } else { for(var i=0;i<fr.length;i++) fr[i]/=s; } }
  function score(active, fr){ var lab=mixFromLadders(active, fr); return {lab:lab, de: deltaE2000(lab, target)}; }

  function localRefine(active, fr){
    normalise(fr);
    var best=score(active, fr);
    var step=0.25, MIN_STEP=0.0002, MAX_IT=(mode==='full'?20000:5000);
    var it=0, improved=true;
    var BLK_IDX = active.indexOf(CODE_BLK);
    var light = target.L>=75;
    function tryAdjust(fr, i, delta){
      var sOthers = 1 - fr[i]; if (sOthers<=0) return false;
      var move = clamp(delta, -fr[i], +sOthers);
      if (move===0) return false;
      for (var k=0;k<fr.length;k++) if(k!==i) fr[k] -= move * (fr[k]/sOthers);
      fr[i] += move; return true;
    }
    while(step>=MIN_STEP && it<MAX_IT){ it++; improved=false;
      for (var i=0;i<fr.length;i++){
        for (var dir=-1; dir<=1; dir+=2){
          var prev = fr.slice();
          if (!tryAdjust(fr, i, dir*step)) continue;
          if (light && i===BLK_IDX){
            var tmp=score(active, fr);
            if (tmp.de < best.de - 0.40){ best=tmp; improved=true; } else { fr=prev; continue; }
          } else {
            var cur=score(active, fr);
            if (cur.de + 1e-6 < best.de){ best=cur; improved=true; } else { fr=prev; }
          }
        }
      }
      for (var i2=0;i2<fr.length;i2++) for (var j2=i2+1;j2<fr.length;j2++){
        var prev2=fr.slice();
        var eps = step*0.7;
        fr[i2]=clamp(fr[i2]+eps,0,1); fr[j2]=clamp(fr[j2]-eps,0,1); normalise(fr);
        var cur2=score(active, fr);
        if (cur2.de + 1e-6 < best.de){ best=cur2; improved=true; } else { fr=prev2; }
      }
      if(!improved){
        var r = Math.floor(Math.random()*fr.length);
        tryAdjust(fr, r, (Math.random()*2-1)*step*0.1);
        step*=0.5;
      }
    }
    return {codes:active.slice(), fracs:fr.slice(), lab:best.lab, dE:best.de};
  }

  function anneal(active, fr){
    normalise(fr);
    var best = score(active, fr), bestFr=fr.slice();
    var cur = best, curFr=fr.slice();
    var T0 = (mode==='full'? 0.25 : 0.10), Tend=(mode==='full'? 0.0005 : 0.002), steps=(mode==='full'? 5000 : 200);
    for (var s=0;s<steps;s++){
      var T = T0 * Math.pow(Tend/T0, s/(steps-1));
      var i=Math.floor(Math.random()*fr.length); var j=Math.floor(Math.random()*fr.length); if(i===j) j=(j+1)%fr.length;
      var prev=curFr.slice();
      var amt=(Math.random()*2-1)*(mode==='full'? 0.12:0.06);
      var take = clamp(amt, -curFr[i], curFr[j]);
      curFr[i]+=take; curFr[j]-=take; normalise(curFr);
      var prop=score(active, curFr);
      var d=prop.de - cur.de;
      if (d<0 || Math.exp(-d/Math.max(1e-9,T))>Math.random()){
        cur=prop; if (cur.de<best.de){ best=prop; bestFr=curFr.slice(); }
      } else { curFr=prev; }
    }
    return {codes:active.slice(), fracs:bestFr.slice(), lab:best.lab, dE:best.de};
  }

  var globalBest=null;
  var NUM_SEEDS = (mode==='full' ? 320 : 16);
  var comboSets = [];
  function pushCombo(arr){ var seenSet=new Set(); var ded=arr.filter(function(c){ if(seenSet.has(c)) return false; seenSet.add(c); return true; }); if (ded.length>=2) comboSets.push(ded); }
  function pickActive(){ var light = target.L>=75; var base=[]; if (light && CODE_WHT) base.push(CODE_WHT); else if (light && CODE_EXT) base.push(CODE_EXT); base.push(pool[0]); for (var i=1;i<pool.length && base.length<maxInks; i++) if (base.indexOf(pool[i])<0) base.push(pool[i]); return base; }
  function sampleCombos(){ var light = target.L>=75; pushCombo(pickActive()); if (mode==='full'){ var tries = 500; for (var t=0;t<tries;t++){ var want = Math.min(maxInks, 2 + Math.floor(Math.random()*Math.min(5, maxInks-1))); var combo=[]; if (light && (CODE_WHT||CODE_EXT)) combo.push(CODE_WHT || CODE_EXT); while(combo.length<want){ var c = pool[Math.floor(Math.random()*pool.length)]; if (combo.indexOf(c)<0) combo.push(c); } pushCombo(combo); } } }
  sampleCombos();

  for (var cs=0; cs<comboSets.length; cs++){
    var active = comboSets[cs];
    var light = target.L>=75; var hasBlack = active.indexOf(CODE_BLK)>=0;
    var seeds = (mode==='full'? Math.max((NUM_SEEDS/Math.max(1,comboSets.length/3))|0, 24) : NUM_SEEDS);
    for (var s=0; s<seeds; s++){
      var fr = new Array(active.length); for(var i0=0;i0<fr.length;i0++) fr[i0]=Math.random()+1e-6; var s0=sum(fr); for(var i1=0;i1<fr.length;i1++) fr[i1]/=s0;
      if (light){ var wi = active.indexOf(CODE_WHT)>=0 ? active.indexOf(CODE_WHT) : active.indexOf(CODE_EXT); if (wi>=0){ fr[wi]=Math.max(fr[wi], 0.5); var s1=sum(fr); for(var i2=0;i2<fr.length;i2++) fr[i2]/=s1; } }
      if (light && hasBlack){ var bi=active.indexOf(CODE_BLK); fr[bi]=Math.min(fr[bi], 0.02); var s2=sum(fr); for(var i3=0;i3<fr.length;i3++) fr[i3]/=s2; }
      var A = anneal(active, fr);
      var L = localRefine(A.codes, A.fracs);
      var keptCodes=[], keptFr=[]; for (var i=0;i<L.codes.length;i++){ if (L.fracs[i] >= 0.01) { keptCodes.push(L.codes[i]); keptFr.push(L.fracs[i]); } }
      if (keptCodes.length>0){ var s3=sum(keptFr); for(var j3=0;j3<keptFr.length;j3++) keptFr[j3]/=s3; L = localRefine(keptCodes, keptFr); }
      if (light && L.codes.indexOf(CODE_BLK)>=0 && globalBest && !(L.dE < globalBest.dE - 0.20)){
      } else {
        if (!globalBest || L.dE + 1e-6 < globalBest.dE) globalBest = L;
      }
    }
  }
  if (!globalBest) throw new Error('Optimisation failed to find a recipe');
  return globalBest;
}

// =========== UI glue ===========
function suggestFormula(){
  try{
    var target=getTargetLab(); if(!target){ alert('Enter a valid colour first.'); return; }
    var mode = ($('#mode').value||'fast');
    $('#predictMsg').textContent= mode==='full' ? 'Full Send… this might take a bit' : 'Mixing…';
    var maxInks=Math.max(2, Math.min(8, parseInt($('#maxInks').value || 5, 10)));
    var out=suggestLadderRecipe(target, maxInks, mode);

    var rgb=labToSrgb(out.lab.L, out.lab.a, out.lab.b);
    var total= sum(out.fracs) || 1;
    var merged = out.codes.map(function(code,i){ return { code:code, pct: (out.fracs[i]/total)*100 }; }).sort(function(a,b){ return b.pct-a.pct; });

    var html=''
      + '<div class="row2">'
      +   '<div>'
      +     '<div class="pill">Ladder mix ('+(mode==='full'?'Full Send':'Production')+')</div>'
      +     '<div class="swatch" style="background: rgb('+rgb.r+','+rgb.g+','+rgb.b+'); margin:6px 0 8px"></div>'
      +     '<div class="muted">Predicted: L '+out.lab.L.toFixed(2)+' a '+out.lab.a.toFixed(2)+' b '+out.lab.b.toFixed(2)+' · ΔE00: <strong>'+out.dE.toFixed(2)+'</strong></div>'
      +   '</div>'
      +   '<div style="text-align:right">'
      +     '<button class="btn" onclick="document.querySelector(\'#suggestedFormula\').style.display=\'none\'">Close</button>'
      +   '</div>'
      + '</div>';
    html += '<div class="formula-grid">' + merged.map(function(p){ return '<div class="fg-ink">'+p.code+' — '+codeName(p.code)+'</div><div class="fg-pct">'+p.pct.toFixed(1)+'%</div>'; }).join('') + '</div>';

    var box=$('#suggestedFormula'); if(box){ box.innerHTML=html; box.style.display='block'; }
    $('#predictMsg').textContent='';
  } catch(err){ console.error(err); $('#predictMsg').textContent='Error: '+err.message; }
}

// Wire up
$('#findBtn').addEventListener('click', findClosest);
$('#clearBtn').addEventListener('click', function(){ $('#L').value=''; $('#a').value=''; $('#b').value=''; updateTargetEcho(); $('#resultsTbody').innerHTML=''; $('#formulaPanel').style.display='none'; $('#suggestedFormula').style.display='none'; });
$('#suggestBtn').addEventListener('click', suggestFormula);
$('#pmsBtn').addEventListener('click', findByPms);
['L','a','b'].forEach(function(id){ $('#'+id).addEventListener('input', updateTargetEcho); });

// Load JSON
Promise.all([
  fetch('colours.json').then(function(r){return r.json();}),
  fetch('DC_Formulas.json').then(function(r){return r.json();}),
  fetch('assortment_colour_data.json').then(function(r){return r.json();})
]).then(function(tuple){
  COLOURS=tuple[0]; FORMULAS=tuple[1]; ASSORTMENT=tuple[2]; buildFormulaIndex(); $('#countLabel').textContent=COLOURS.length; loadAssortmentIntoLadders();
  runTests();
}).catch(function(err){ alert('Error loading JSON: '+err); });

updateTargetEcho();

// =========== Minimal tests ===========
function approxEq(a,b,eps){ return Math.abs(a-b) <= (eps||1e-6); }
function runTests(){
  try{
    console.assert(approxEq(deltaE2000({L:50,a:0,b:0},{L:50,a:0,b:0}),0),'DE00 identity');
    var critical=['DC21-002','DC21-901','DC21-802'];
    console.log('[Tests] Ladder inks present:', critical.filter(function(c){return !!LADDER[c];}));
    var codes = getCandidateCodes().slice(0,2);
    if (codes.length>=2){
      var lab1 = mixFromLadders([codes[0],codes[1]],[0.5,0.5]);
      var lab2 = mixFromLadders([codes[0],codes[1]],[0.7,0.3]);
      console.assert(!(approxEq(lab1.L,lab2.L,1e-4)&&approxEq(lab1.a,lab2.a,1e-4)&&approxEq(lab1.b,lab2.b,1e-4)), 'Mix responds to weights');
    }
    var demo = suggestLadderRecipe({L:70,a:5,b:10}, 4, 'fast');
    console.assert(demo && demo.codes && demo.fracs && demo.lab, 'Demo suggestion returns structure');
    console.log('[Tests] OK');
  } catch(e){ console.warn('[Tests] exception', e); }
}

})();
</script>
</body>
</html>
