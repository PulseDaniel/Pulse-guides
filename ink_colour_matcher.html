<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ink Colour Matcher + Predictor</title>
  <style>
    :root { --gap: 12px; --radius: 14px; }
    * { box-sizing: border-box; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin:0; padding:24px; background:#0b0c10; color:#e6e6e6; }
    h1 { font-size: 1.25rem; margin: 0 0 8px; }
    .app { max-width: 1200px; margin: 0 auto; display: grid; gap: var(--gap); grid-template-columns: 420px 1fr; align-items: start; }
    .card { background:#111318; border:1px solid #22252e; border-radius: var(--radius); padding:16px; box-shadow: 0 8px 24px rgba(0,0,0,.25); }
    label { display:block; font-size:.85rem; color:#98a2b3; margin-bottom:6px; }
    input, select { width:100%; padding:10px 12px; border-radius:8px; background:#0e1015; border:1px solid #2a2f3a; color:#e6e6e6; }
    input:focus, select:focus { outline: none; border-color:#3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,.2); }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
    .chip { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; background:#0e1015; border:1px solid #2a2f3a; border-radius:9999px; font-size:.8rem; }
    .swatch { width:28px; height:18px; border-radius:6px; border:1px solid #333; display:inline-block; vertical-align:middle; }
    table { width:100%; border-collapse: collapse; font-size:.9rem; }
    th, td { padding:8px 8px; border-bottom:1px solid #1c1f26; }
    th { text-align:left; color:#98a2b3; font-weight:600; }
    .kpi { display:grid; grid-template-columns: repeat(3, 1fr); gap:var(--gap); margin-top:12px; }
    .kpi .card { text-align:center; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .btn { display:inline-flex; align-items:center; justify-content:center; padding:10px 12px; border-radius:8px; border:1px solid #2a2f3a; background:#0e1015; color:#e6e6e6; cursor:pointer; }
    .btn:hover { border-color:#3b82f6; }
    .muted { color:#8a94a6; font-size:.85rem; }
    details.press { margin-top: 12px; }
    details.press summary { cursor: pointer; color:#98a2b3; }
    .grid4 { display:grid; grid-template-columns: repeat(2, 1fr); gap: var(--gap); }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <h1>Ink Colour Matcher + Predictor</h1>
      <div class="row" style="margin-top:12px;">
        <div>
          <label>Search PMS/Name</label>
          <input id="search" placeholder="Type a PMS name (e.g. ‘PANTONE 185 C’) or a colour name..."/>
        </div>
        <div>
          <label>or Enter Target Lab</label>
          <div class="row">
            <input id="L" type="number" step="0.1" placeholder="L*"/>
            <input id="a" type="number" step="0.1" placeholder="a*"/>
            <input id="b" type="number" step="0.1" placeholder="b*"/>
          </div>
        </div>
      </div>

      <div style="margin-top:12px">
        <label>Closest Matches</label>
        <div id="matches" class="muted">Type to see matches…</div>
      </div>

      <div style="margin-top:12px">
        <label>Known Formula (if any)</label>
        <div id="known" class="muted">—</div>
      </div>

      <div class="kpi">
        <div class="card">
          <div class="muted">Target</div>
          <div style="display:flex; align-items:center; gap:8px; justify-content:center; margin-top:6px;">
            <span class="swatch" id="targetSw"></span>
            <span id="targetLabEcho" class="mono"></span>
          </div>
        </div>
        <div class="card">
          <div class="muted">Predicted Mix</div>
          <div style="display:flex; align-items:center; gap:8px; justify-content:center; margin-top:6px;">
            <span class="swatch" id="mixSw"></span>
            <span id="mixLabEcho" class="mono"></span>
          </div>
        </div>
        <div class="card">
          <div class="muted">ΔE00</div>
          <div style="font-size:1.4rem; font-weight:700; margin-top:6px;" id="dE">—</div>
        </div>
      </div>

      <div style="margin-top:12px">
        <label>Max inks to use</label>
        <select id="maxInks">
          <option>2</option>
          <option selected>3</option>
          <option>4</option>
          <option>5</option>
        </select>
      </div>

      <details class="press">
        <summary>Press settings (anilox laydown)</summary>
        <div class="grid4" style="margin-top:8px">
          <div>
            <label>Anilox volume (BCM/in²)</label>
            <input id="pressBCM" type="number" step="0.1" value="6"/>
          </div>
          <div>
            <label>Transfer efficiency η (0–1)</label>
            <input id="pressEta" type="number" step="0.05" value="0.6"/>
          </div>
          <div>
            <label>Ink density (g/mL)</label>
            <input id="pressDensity" type="number" step="0.05" value="1.00"/>
          </div>
          <div>
            <label>Solids fraction (0–1)</label>
            <input id="pressSolids" type="number" step="0.05" value="0.35"/>
          </div>
          <div>
            <label>κ (thickness calibration)</label>
            <input id="pressKappa" type="number" step="0.05" value="1.00"/>
          </div>
        </div>
        <div class="muted" style="margin-top:8px">X = κ × 1.55 × BCM × η × density × solids (optical thickness scale)</div>
      </details>

      <div style="margin-top:12px">
        <button class="btn" id="predict">Suggest Mix</button>
      </div>
    </div>

    <div class="card">
      <h1>Suggested Formula</h1>
      <div id="formula">—</div>
    </div>
  </div>

<script>
// ===== Color math (Lab/XYZ, ΔE00, sRGB) =====
function labToXyz(L,a,b){
  var Yn = 100.0, Xn = 95.047, Zn = 108.883;
  var fy = (L + 16)/116.0;
  var fx = fy + a/500.0;
  var fz = fy - b/200.0;
  function finv(t){ var t3=t*t*t; return (t3>0.008856)? t3 : (t - 16/116)/7.787; }
  var xr = finv(fx); var yr = finv(fy); var zr = finv(fz);
  return [xr*Xn, yr*Yn, zr*Zn];
}
function xyzToLab(X,Y,Z){
  var Yn = 100.0, Xn = 95.047, Zn = 108.883;
  function f(t){ var e=216/24389, k=24389/27; return (t>e)? Math.cbrt(t) : (k*t+16)/116; }
  var xr = X/Xn, yr = Y/Yn, zr = Z/Zn;
  var fx=f(xr), fy=f(yr), fz=f(zr);
  return {L: 116*fy-16, a: 500*(fx-fy), b: 200*(fy-fz)};
}
function labToSrgb(L,a,b){
  var xyz = labToXyz(L,a,b);
  var x=xyz[0]/100, y=xyz[1]/100, z=xyz[2]/100;
  var rl =  3.2406*x + -1.5372*y + -0.4986*z;
  var gl = -0.9689*x +  1.8758*y +  0.0415*z;
  var bl =  0.0557*x + -0.2040*y +  1.0570*z;
  function comp(u){ u=Math.max(0,Math.min(1,u)); return (u<=0.0031308)? 12.92*u : 1.055*Math.pow(u,1/2.4)-0.055; }
  return { r: Math.round(comp(rl)*255), g: Math.round(comp(gl)*255), b: Math.round(comp(bl)*255) };
}
function hp(x,y){ var h=Math.atan2(y,x)*180/Math.PI; return (h>=0?h:h+360); }
function deltaE2000(l1,l2){
  var L1=l1.L,a1=l1.a,b1=l1.b, L2=l2.L,a2=l2.a,b2=l2.b;
  var deg2rad=Math.PI/180;
  var avgLp=(L1+L2)/2;
  var C1=Math.hypot(a1,b1), C2=Math.hypot(a2,b2);
  var avgC=(C1+C2)/2;
  var G=0.5*(1-Math.sqrt(Math.pow(avgC,7)/(Math.pow(avgC,7)+Math.pow(25,7))));
  var a1p=(1+G)*a1, a2p=(1+G)*a2;
  var C1p=Math.hypot(a1p,b1), C2p=Math.hypot(a2p,b2);
  var avgCp=(C1p+C2p)/2;
  var h1p=(Math.abs(a1p)<1e-9 && Math.abs(b1)<1e-9)?0:hp(a1p,b1);
  var h2p=(Math.abs(a2p)<1e-9 && Math.abs(b2)<1e-9)?0:hp(a2p,b2);
  var dhp=h2p-h1p; if(dhp>180) dhp-=360; if(dhp<-180) dhp+=360;
  var dLp=L2-L1, dCp=C2p-C1p, dHp=2*Math.sqrt(C1p*C2p)*Math.sin((dhp*deg2rad)/2);
  var avgHp=h1p+h2p; if(Math.abs(h1p-h2p)>180) avgHp+=360; avgHp/=2;
  var T=1-0.17*Math.cos((avgHp-30)*deg2rad)+0.24*Math.cos(2*avgHp*deg2rad)+0.32*Math.cos((3*avgHp+6)*deg2rad)-0.20*Math.cos((4*avgHp-63)*deg2rad);
  var Sl=1+0.015*Math.pow(avgLp-50,2)/Math.sqrt(20+Math.pow(avgLp-50,2));
  var Sc=1+0.045*avgCp;
  var Sh=1+0.015*avgCp*T;
  var Rt=-2*Math.sqrt(Math.pow(avgCp,7)/(Math.pow(avgCp,7)+Math.pow(25,7)))*Math.sin((60*Math.exp(-Math.pow((avgHp-275)/25,2)))*deg2rad);
  return Math.sqrt(Math.pow(dLp/Sl,2)+Math.pow(dCp/Sc,2)+Math.pow(dHp/Sh,2)+Rt*(dCp/Sc)*(dHp/Sh));
}

// ===== State =====
var COLOURS = [];// from colours.json
var FORMULAS = {};// from DC_Formulas.json (can be workbook-style)
var ASSORTMENT = {};// from assortment_colour_data.json { ink: {white:[{conc,L,a,b}], black:[...] } }

// Name & PMS helpers
function normaliseName(s){ return String(s||'').trim().toUpperCase().replace(/\s+/g,' '); }
function extractPmsNumber(name){
  var m = /PANTONE\s+([0-9]{2,4})\s*([A-Z])/.exec(String(name||''));
  return m? (m[1]+' '+m[2]) : null;
}

function updateTargetEcho(){
  var L = parseFloat(document.getElementById('L').value||'');
  var a = parseFloat(document.getElementById('a').value||'');
  var b = parseFloat(document.getElementById('b').value||'');
  if(isFinite(L)&&isFinite(a)&&isFinite(b)){
    var rgb = labToSrgb(L,a,b);
    document.getElementById('targetSw').style.background = 'rgb('+rgb.r+','+rgb.g+','+rgb.b+')';
    document.getElementById('targetLabEcho').textContent = 'L '+L.toFixed(1)+'  a '+a.toFixed(1)+'  b '+b.toFixed(1);
  }
}

var FORMULAS_NORM = {};
var COLOUR_TO_FORMULA = {};
function buildFormulaIndex(){
  var rows = [];
  FORMULAS_NORM = {};
  COLOUR_TO_FORMULA = {};
  if (Array.isArray(FORMULAS)) {
    rows.push.apply(rows, FORMULAS);
  } else if (FORMULAS && typeof FORMULAS === 'object') {
    Object.keys(FORMULAS).forEach(function(k){
      if (Array.isArray(FORMULAS[k])) rows.push.apply(rows, FORMULAS[k]);
      else if (FORMULAS[k] && typeof FORMULAS[k] === 'object' && Array.isArray(FORMULAS[k].rows)) rows.push.apply(rows, FORMULAS[k].rows);
    });
  }
  rows.forEach(function(r){
    var colour = normaliseName(r.Colour||r.color||r.name||'');
    var parts = [];
    for (var i=1;i<=6;i++){
      var ing = r['Ingredient '+i]; var pct = r['%'+(i>1?i:'')];
      if(ing && pct>0) parts.push({ink:ing.trim(), pct: Number(pct)});
    }
    var sum = parts.reduce(function(a,b){return a + (b.pct||0);}, 0) || 1;
    FORMULAS_NORM[colour] = parts.map(function(p){ return {ink:p.ink, pct: (p.pct||0)/sum}; });
    COLOUR_TO_FORMULA[colour] = FORMULAS_NORM[colour];
  });
}

function showFormulaFor(colourName){
  var el = document.getElementById('known');
  var key = normaliseName(colourName||'');
  var f = COLOUR_TO_FORMULA[key];
  if(!f){ el.textContent = '—'; return; }
  el.innerHTML = f.map(function(p){ return '<span class="chip"><span class="swatch" style="background:#1f2430"></span>'+p.ink+': <b>'+(p.pct*100).toFixed(1)+'%</b></span>'; }).join(' ');
}

// ===== Predictor (KM‑lite with pseudo‑bands X,Y,Z; D65 2°) =====
function xyzToBands(x,y,z){ var Xn=95.047, Yn=100.000, Zn=108.883; return [Math.max(0, Math.min(1, x/Xn)), Math.max(0, Math.min(1, y/Yn)), Math.max(0, Math.min(1, z/Zn))]; }
function bandsToXyz(bands){ var Xn=95.047, Yn=100.000, Zn=108.883; return [bands[0]*Xn, bands[1]*Yn, bands[2]*Zn]; }
function R_infty_from_KS(K,S){ var a=(K+S)/S; var b=Math.sqrt(Math.max(0,a*a-1)); return a-b; }
function L_from_KS(K,S){ return Math.sqrt(Math.max(0, K*(K+2*S))); }
function KM_reflectance_over_backing(K,S,X,Rg){ var Rinf=R_infty_from_KS(K,S); var L=L_from_KS(K,S); var E=Math.exp(2*L*X); var num=(Rg-Rinf)/Rinf - Rinf*(Rg - 1/Rinf)*E; var den=(Rg-Rinf) - (Rg - 1/Rinf)*E; var R=num/den; if(!isFinite(R)) R=(E>1e6)?Rinf: Rg; return Math.max(0, Math.min(1, R)); }

// ---- Press laydown → optical thickness ----
function clamp01(v){ return Math.max(0, Math.min(1, v)); }
function getPressTheta(){
  var BCM = parseFloat(document.getElementById('pressBCM').value||'6');
  var eta = clamp01(parseFloat(document.getElementById('pressEta').value||'0.6'));
  var rho = Math.max(0.5, parseFloat(document.getElementById('pressDensity').value||'1.0'));
  var solids = clamp01(parseFloat(document.getElementById('pressSolids').value||'0.35'));
  var kappa = Math.max(0.01, parseFloat(document.getElementById('pressKappa').value||'1.0'));
  var Vwet = 1.55 * BCM * eta; // mL/m²
  var Wdry = Vwet * rho * solids; // g/m² (approx)
  var theta = kappa * Wdry; // optical thickness scale
  return theta;
}

function buildInkModels(){
  var models = {}; var inks = Object.keys(ASSORTMENT);
  for(var i=0;i<inks.length;i++){
    var ink = inks[i]; var rec = ASSORTMENT[ink]||{}; var W=(rec.white||[]), B=(rec.black||[]); if(!W||W.length===0) continue;
    var samplesW = W.map(function(e){ var xyz=labToXyz(e.L,e.a,e.b); return {conc:e.conc, R: xyzToBands(xyz[0],xyz[1],xyz[2])}; });
    var samplesB = B.map(function(e){ var xyz=labToXyz(e.L,e.a,e.b); return {conc:e.conc, R: xyzToBands(xyz[0],xyz[1],xyz[2])}; });
    var S=1.0; var Kinit=[0.5,0.5,0.5]; var top=samplesW[samplesW.length-1];
    if(top){ for(var j=0;j<3;j++){ var Rw=Math.max(1e-6, Math.min(0.999999, top.R[j])); var F=(1-Rw)*(1-Rw)/(2*Rw); Kinit[j]=Math.max(1e-6, Math.min(50, F)); } }
    var K=Kinit.slice(), alpha=1.0;
    function errFor(Kx,Ky,Kz,a){ var e2=0; function pred(conc,Rg,band){ var t=a*(conc/100.0); var Kb=(band===0?Kx:(band===1?Ky:Kz)); return KM_reflectance_over_backing(Kb,1.0,t,Rg);} for(var s=0;s<samplesW.length;s++){ var sw=samplesW[s]; for(var j=0;j<3;j++){ var d=pred(sw.conc,1.0,j)-sw.R[j]; e2+=d*d; } } for(var s2=0;s2<samplesB.length;s2++){ var sb=samplesB[s2]; for(var j2=0;j2<3;j2++){ var d2=pred(sb.conc,0.0,j2)-sb.R[j2]; e2+=d2*d2; } } e2+=1e-4*(Kx+Ky+Kz); return e2; }
    var best={K:K.slice(), alpha:alpha, e:errFor(K[0],K[1],K[2],alpha)};
    for(var r=0;r<10;r++){
      var Kc=[Math.max(1e-4,Kinit[0]*(0.5+Math.random()*2)),Math.max(1e-4,Kinit[1]*(0.5+Math.random()*2)),Math.max(1e-4,Kinit[2]*(0.5+Math.random()*2))];
      var ac=Math.max(0.05, Math.min(5, Math.pow(2,-1+2*Math.random()))); var ecur=errFor(Kc[0],Kc[1],Kc[2],ac); var stepK=0.5, stepA=0.5;
      for(var it=0; it<120; it++){
        var improved=false;
        for(var j=0;j<3;j++){ var Ktry=Kc.slice(); Ktry[j]=Math.max(1e-6, Kc[j]*(1 + (Math.random()<0.5?-1:1)*stepK)); var e1=errFor(Ktry[0],Ktry[1],Ktry[2],ac); if(e1<ecur){ Kc=Ktry; ecur=e1; improved=true; } }
        var atry=Math.max(1e-3, ac*(1 + (Math.random()<0.5?-1:1)*stepA)); var e2=errFor(Kc[0],Kc[1],Kc[2],atry); if(e2<ecur){ ac=atry; ecur=e2; improved=true; }
        if(!improved){ stepK*=0.7; stepA*=0.7; if(stepK<1e-3 && stepA<1e-3) break; }
      }
      if(ecur<best.e){ best={K:Kc.slice(), alpha:ac, e:ecur}; }
    }
    models[ink]={ name:ink, K:best.K, S:1.0, alpha:best.alpha };
  }
  return models;
}
var INK_MODELS=null;
function buildWhiteBasis(){ var basis=[]; Object.keys(ASSORTMENT).forEach(function(ink){ (ASSORTMENT[ink].white||[]).forEach(function(e){ var xyz=labToXyz(e.L,e.a,e.b); basis.push({ name:(ink+' '+e.conc+'%'), ink:ink, conc:e.conc, vec:[xyz[0],xyz[1],xyz[2]] }); }); }); return basis; }
function refineWeightsKM(basis, wInit, targetLab, maxIters, theta){
  var byInk=new Map(); for(var j=0;j<basis.length;j++){ var wt=wInit[j]||0; if(wt<=0) continue; var ink=basis[j].ink; byInk.set(ink,(byInk.get(ink)||0)+wt); }
  var inks=Array.from(byInk.keys()); var w=inks.map(function(k){return byInk.get(k)||0;}); var s=w.reduce(function(a,b){return a+b;},0); if(s>0){ w=w.map(function(v){return v/s;}); } else { w[0]=1; }
  if(!INK_MODELS) INK_MODELS=buildInkModels();
  function predictLabFromInkWeights(wVec, thetaVal){ var Kmix=[0,0,0], Xmix=0.0; var tv=(thetaVal==null?1.0:thetaVal); for(var i=0;i<inks.length;i++){ var mdl=INK_MODELS[inks[i]]; var wi=wVec[i]||0; if(!mdl||wi<=0) continue; Kmix[0]+=wi*mdl.K[0]; Kmix[1]+=wi*mdl.K[1]; Kmix[2]+=wi*mdl.K[2]; Xmix+=wi*mdl.alpha; }
    Xmix = tv * Xmix; // press-aware thickness
    var bands=[KM_reflectance_over_backing(Kmix[0],1.0,Xmix,1.0), KM_reflectance_over_backing(Kmix[1],1.0,Xmix,1.0), KM_reflectance_over_backing(Kmix[2],1.0,Xmix,1.0)]; var xyz=bandsToXyz(bands); return xyzToLab(xyz[0],xyz[1],xyz[2]); }
  function loss(wVec){ var lab=predictLabFromInkWeights(wVec, theta); return deltaE2000(lab, targetLab); }
  var LR=0.2, bestLoss=loss(w); for(var it=0; it<(maxIters||200); it++){ var improved=false; for(var i=0;i<inks.length;i++){ for(var j=i+1;j<inks.length;j++){ var move=Math.min(LR, w[i]); if(move>1e-6){ var wTry=w.slice(); wTry[i]-=move; wTry[j]+=move; var L=loss(wTry); if(L+1e-9<bestLoss){ w=wTry; bestLoss=L; improved=true; } else { var move2=Math.min(LR, w[j]); var wTry2=w.slice(); wTry2[j]-=move2; wTry2[i]+=move2; var L2=loss(wTry2); if(L2+1e-9<bestLoss){ w=wTry2; bestLoss=L2; improved=true; } } } } } if(!improved){ LR*=0.6; if(LR<1e-4) break; } }
  var wOut=new Array(basis.length).fill(0), perInkSum={}; for(var k=0;k<basis.length;k++){ var ink=basis[k].ink; perInkSum[ink]=(perInkSum[ink]||0)+(wInit[k]||0); }
  for(var k2=0;k<basis.length;k2++){ var ink2=basis[k2].ink; var share=(perInkSum[ink2]>0)?((wInit[k2]||0)/perInkSum[ink2]):0; var idx=inks.indexOf(ink2); var inkWeight=(idx>=0)?w[idx]:0; wOut[k2]=share*inkWeight; }
  return { weights:wOut, predictLabFromInkWeights:predictLabFromInkWeights, inks:inks, inkWeights:w, loss:bestLoss };
}

function fwSimplex(A, y, iters, seed){
  // existing simplex solver kept for seeding (unchanged)
  var m=A[0].length; var w = (seed||new Array(m).fill(0).map(function(_,i){return 1/m;})).slice();
  function Ax(i){ var s=0; for(var j=0;j<m;j++) s+=A[i][j]*w[j]; return s; }
  function grad(){ var g=new Array(m).fill(0); for(var j=0;j<m;j++){ g[j]= 2*(A[0][j]*(Ax(0)-y[0]) + A[1][j]*(Ax(1)-y[1]) + A[2][j]*(Ax(2)-y[2])); } return g; }
  for(var it=0; it<(iters||1000); it++){
    var g=grad(); var jMin=0; for(var j=1;j<m;j++) if(g[j]<g[jMin]) jMin=j; // FW atom
    var d=new Array(m).fill(0); d[jMin]=1; for(var j=0;j<m;j++) d[j]-=w[j];
    // line search
    var Ad=[ A[0][jMin]-Ax(0), A[1][jMin]-Ax(1), A[2][jMin]-Ax(2) ];
    var num = -(Ad[0]*(Ax(0)-y[0]) + Ad[1]*(Ax(1)-y[1]) + Ad[2]*(Ax(2)-y[2]));
    var den =  (Ad[0]*Ad[0] + Ad[1]*Ad[1] + Ad[2]*Ad[2]);
    var gamma = (den>0)? Math.max(0, Math.min(1, num/den)) : 0;
    for(var j2=0;j2<m;j2++){ w[j2] = w[j2] + gamma*d[j2]; }
  }
  return w;
}

function predictMix(targetLab, maxInks, theta){
  if(!INK_MODELS) INK_MODELS = buildInkModels();
  var basis = buildWhiteBasis();
  var A=[[],[],[]]; var tXYZ=labToXyz(targetLab.L, targetLab.a, targetLab.b); var y=[tXYZ[0],tXYZ[1],tXYZ[2]];
  for(var i=0;i<basis.length;i++){ A[0][i]=basis[i].vec[0]; A[1][i]=basis[i].vec[1]; A[2][i]=basis[i].vec[2]; }
  var seed=new Array(basis.length).fill(0); for(var i2=0;i2<basis.length;i2++){ var ink=String(basis[i2].ink||''); if(/EXTENDER|DC21-00[12]/i.test(ink)){ seed[i2]=0.7; break; } }
  var sumSeed=seed.reduce(function(a,b){return a+b;},0); if(sumSeed===0) seed[0]=1; else seed=seed.map(function(v){return v/sumSeed;});
  var w0=fwSimplex(A,y,1500,seed);
  var ref=refineWeightsKM(basis,w0,targetLab,300,theta);
  var labMix=ref.predictLabFromInkWeights(ref.inkWeights, theta); var dE=deltaE2000(labMix, targetLab); var rgb=labToSrgb(labMix.L,labMix.a,labMix.b);
  var byInk=new Map(); for(var q=0;q<basis.length;q++){ if(ref.weights[q]<=1e-9) continue; byInk.set(basis[q].ink,(byInk.get(basis[q].ink)||0)+ref.weights[q]); }
  var merged=Array.from(byInk.entries()).map(function(p){return {ink:p[0], weight:p[1]};}).sort(function(a,b){return b.weight-a.weight;});
  merged=merged.slice(0, maxInks||4); var sumW=merged.reduce(function(a,b){return a+b.weight;},0)||1; merged.forEach(function(m){ m.weight=m.weight/sumW; });
  var finalW=new Array(basis.length).fill(0), counts={}; var inkSet=new Set(merged.map(function(m){return m.ink;});
  for(var i3=0;i3<basis.length;i3++){ if(!inkSet.has(basis[i3].ink)) continue; counts[basis[i3].ink]=(counts[basis[i3].ink]||0)+1; }
  merged.forEach(function(m){ var per=m.weight/(counts[m.ink]||1); for(var i4=0;i4<basis.length;i4++){ if(basis[i4].ink===m.ink) finalW[i4]=per; } });
  return { basis:basis, weights:finalW, byInk:merged, mixLab:labMix, dE:dE, rgb:rgb };
}

// ===== UI glue =====
function $(q){ return document.querySelector(q); }
function renderMatches(list){
  var box=document.getElementById('matches');
  if(!list||list.length===0){ box.textContent='No matches'; return; }
  var tbody=document.createElement('div');
  list.slice(0,8).forEach(function(c){
    var rgb=labToSrgb(c.L,c.a,c.b);
    var div=document.createElement('div');
    div.style.display='flex'; div.style.justifyContent='space-between'; div.style.alignItems='center'; div.style.padding='6px 0';
    div.innerHTML='<span class="chip"><span class="swatch" style="background:rgb('+rgb.r+','+rgb.g+','+rgb.b+')"></span>'+c.name+'</span>'+
                  '<span class="mono">L '+c.L.toFixed(1)+' a '+c.a.toFixed(1)+' b '+c.b.toFixed(1)+'</span>';
    div.addEventListener('click', function(){ document.getElementById('L').value=c.L; document.getElementById('a').value=c.a; document.getElementById('b').value=c.b; updateTargetEcho(); showFormulaFor(c.name||c.Colour||c.color||''); });
    tbody.appendChild(div);
  });
  box.innerHTML=''; box.appendChild(tbody);
}

function showSuggestion(s){
  var f = document.getElementById('formula');
  if(!s || !s.byInk || s.byInk.length===0){ f.textContent='—'; return; }
  var rows = s.byInk.map(function(p){ return '<tr><td>'+p.ink+'</td><td style="width:120px"><div style="height:10px; background:#1a1d25; border-radius:999px; overflow:hidden;"><div style="height:10px; width:'+(p.weight*100).toFixed(1)+'%; background:#3b82f6"></div></div></td><td class="mono">'+(p.weight*100).toFixed(1)+'%</td></tr>'; }).join('');
  f.innerHTML = '<table><thead><tr><th>Ink</th><th>Share</th><th>%</th></tr></thead><tbody>'+rows+'</tbody></table>';
}

function approx(a,b,eps){ return Math.abs(a-b) <= (eps||1e-9); }

function storePressSettings(){
  var payload={BCM:$('#pressBCM').value, eta:$('#pressEta').value, rho:$('#pressDensity').value, solids:$('#pressSolids').value, kappa:$('#pressKappa').value};
  localStorage.setItem('pressSettings', JSON.stringify(payload));
}
function loadPressSettings(){
  try{ var j=JSON.parse(localStorage.getItem('pressSettings')||'{}'); if(j.BCM) $('#pressBCM').value=j.BCM; if(j.eta) $('#pressEta').value=j.eta; if(j.rho) $('#pressDensity').value=j.rho; if(j.solids) $('#pressSolids').value=j.solids; if(j.kappa) $('#pressKappa').value=j.kappa; }catch(e){}
}

function wireUp(){
  document.getElementById('search').addEventListener('input', function(){
    var q = normaliseName(this.value||'');
    if(!q){ document.getElementById('matches').textContent='Type to see matches…'; return; }
    var hits = COLOURS.filter(function(c){ return normaliseName(c.name||c.Colour||c.color||'').indexOf(q)>=0; });
    renderMatches(hits.slice(0,12));
  });
  ['L','a','b'].forEach(function(id){ document.getElementById(id).addEventListener('input', updateTargetEcho); });
  ['pressBCM','pressEta','pressDensity','pressSolids','pressKappa'].forEach(function(id){ var el=document.getElementById(id); el.addEventListener('change', storePressSettings); el.addEventListener('input', storePressSettings); });
  loadPressSettings();
  document.getElementById('predict').addEventListener('click', function(){
    var L=parseFloat(document.getElementById('L').value||'');
    var a=parseFloat(document.getElementById('a').value||'');
    var b=parseFloat(document.getElementById('b').value||'');
    if(!isFinite(L)||!isFinite(a)||!isFinite(b)) return;
    var targetLab={L:L,a:a,b:b}; var maxInks=parseInt(document.getElementById('maxInks').value||'3',10);
    var theta = getPressTheta();
    var res = predictMix(targetLab, maxInks, theta);
    var rgb = res.rgb; document.getElementById('mixSw').style.background='rgb('+rgb.r+','+rgb.g+','+rgb.b+')';
    document.getElementById('mixLabEcho').textContent='L '+res.mixLab.L.toFixed(1)+'  a '+res.mixLab.a.toFixed(1)+'  b '+res.mixLab.b.toFixed(1);
    document.getElementById('dE').textContent = res.dE.toFixed(2);
    showSuggestion(res);
  });
}

// ===== Data loading =====
Promise.all([
  fetch('colours (1).json').then(r=>r.json()),
  fetch('DC_Formulas (1).json').then(r=>r.json()),
  fetch('assortment_colour_data (1).json').then(r=>r.json())
]).then(function(all){
  COLOURS = all[0];
  FORMULAS = all[1]; buildFormulaIndex();
  ASSORTMENT = all[2];
  wireUp();
  // preload a demo match
  var demo = COLOURS[0]; document.getElementById('search').value = demo.name; document.getElementById('search').dispatchEvent(new Event('input'));
  document.getElementById('L').value = demo.L; document.getElementById('a').value = demo.a; document.getElementById('b').value = demo.b; updateTargetEcho(); showFormulaFor(demo.name);
});
</script>
</body>
</html>
