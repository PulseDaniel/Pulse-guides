<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ink Colour Matcher — Spectral KM (Hybrid)</title>
  <style>
    :root { --gap: 12px; --radius: 14px; }
    * { box-sizing: border-box; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin:0; padding:24px; background:#0b0c10; color:#e6e6e6; }
    h1 { font-size: 1.25rem; margin: 0 0 8px; }
    .app { max-width: 1250px; margin: 0 auto; display: grid; gap: var(--gap); grid-template-columns: 460px 1fr; align-items: start; }
    .card { background:#111318; border:1px solid #22252e; border-radius: var(--radius); padding:16px; box-shadow: 0 8px 24px rgba(0,0,0,.25); }
    label { display:block; font-size:.85rem; color:#98a2b3; margin-bottom:6px; }
    input, select { width:100%; padding:10px 12px; border-radius:10px; outline:none; background:#0e1015; border:1px solid #2a2f3a; color:#e6e6e6; }
    input::placeholder { color:#7b8496; }
    .row { display:grid; grid-template-columns:1fr 1fr 1fr; gap:var(--gap); }
    .row2 { display:grid; grid-template-columns:1fr 1fr; gap:var(--gap); }
    .btn { cursor:pointer; padding:10px 12px; border-radius:10px; border:1px solid #2a2f3a; background:#141824; color:#e6e6e6; font-weight:600; }
    .btn:hover { filter:brightness(1.1); }
    table { width:100%; border-collapse:collapse; }
    th, td { text-align:left; padding:10px; border-bottom:1px dashed #242938; font-variant-numeric: tabular-nums; }
    th { color:#9aa4b2; font-weight:600; }
    .result-row { transition: background .2s; cursor:pointer; }
    .result-row:hover { background: rgba(255,255,255,.05); }
    .swatch { width:3.1rem; height:2.1rem; border-radius:6px; border:1px solid rgba(255,255,255,.2); }
    .pill { font-size:.8rem; color:#98a2b3; }
    .muted { color:#7b8496; font-size:.85rem; }
    .formula-box { background:#0e1015; border:1px solid #2a2f3a; border-radius:10px; padding:12px; margin-top:16px; }
    .formula-box h2 { margin:0 0 8px; font-size:1rem; color:#ccc; }
    .formula-grid { display:grid; grid-template-columns: 1fr auto; column-gap: 12px; row-gap: 6px; align-items:center; }
    .fg-ink { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .fg-pct { text-align:right; min-width:4ch; font-variant-numeric: tabular-nums; color:#cbd5e1; }
    .stack { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .flex { display:flex; gap:8px; }
    @media (max-width: 900px) { .app { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <div class="top" style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap: wrap;">
        <h1>Ink Colour Matcher — Spectral KM</h1>
        <div class="pill"><span id="countLabel">0</span> reference colours</div>
      </div>

      <div class="row" style="margin-top:12px;">
        <div><label for="L">L*</label><input id="L" type="number" step="0.01" placeholder="e.g. 52.30"></div>
        <div><label for="a">a*</label><input id="a" type="number" step="0.01" placeholder="e.g. 12.80"></div>
        <div><label for="b">b*</label><input id="b" type="number" step="0.01" placeholder="e.g. -4.10"></div>
      </div>

      <div class="row2" style="margin-top:12px;">
        <div>
          <label for="pms">Search by PMS (number only)</label>
          <input id="pms" type="text" placeholder="e.g. 186 or 3005"/>
        </div>
        <div style="align-self:end;">
          <button class="btn" id="pmsBtn">Find PMS</button>
        </div>
      </div>

      <div class="flex" style="margin-top:12px;">
        <button class="btn" id="findBtn">Find Closest</button>
        <button class="btn" id="clearBtn">Clear</button>
        <span class="muted" id="statusMsg" aria-live="polite"></span>
      </div>

      <div class="formula-box" id="predictorBox">
        <h2>Suggest Formula (Spectral KM)</h2>
        <div class="row2" style="margin-bottom:8px;">
          <div>
            <label for="maxInks">Max inks in recipe</label>
            <input id="maxInks" type="number" min="2" max="8" step="1" value="5"/>
          </div>
          <div>
            <label for="mode">Mode</label>
            <select id="mode">
              <option value="fast">Production (fast)</option>
              <option value="full" selected>Full Send (thorough)</option>
            </select>
          </div>
        </div>
        <div class="flex">
          <button class="btn" id="suggestBtn">Suggest Formula</button>
          <div id="predictMsg" class="muted" style="align-self:center;"></div>
        </div>
        <div id="suggestedFormula" class="formula-box" style="display:none;"></div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;">
        <h1>Closest Matches</h1>
        <div class="stack" style="align-items:center;">
          <div class="swatch" id="targetSwatch" title="Target"></div>
          <div class="muted" id="targetEcho">Target: –</div>
        </div>
      </div>
      <table>
        <thead>
          <tr><th>Colour</th><th>Swatch</th><th>L*</th><th>a*</th><th>b*</th><th>Distance</th></tr>
        </thead>
        <tbody id="resultsTbody"></tbody>
      </table>
      <div id="formulaPanel" class="formula-box" style="display:none;"></div>
    </div>
  </div>

<script>
(function(){
'use strict';
// ====== Small utils ======
function $(sel){ return document.querySelector(sel); }
function clamp(v, lo, hi){ return Math.min(hi, Math.max(lo, v)); }
function sum(a){ var s=0; for(var i=0;i<a.length;i++) s+=a[i]; return s; }
function linspace(a,b,n){ var out=[], step=(b-a)/(n-1); for(var i=0;i<n;i++) out.push(a+i*step); return out; }

// ====== CIE constants (D50/2°) ======
// Wavelengths 380-730nm (10nm)
var WL = []; for (var w=380; w<=730; w+=10) WL.push(w);
// 1931 2° CMFs (xbar, ybar, zbar) @ 10nm (trimmed/rounded). D50 SPD @ 10nm (relative).
// Values from CIE tables (condensed). These arrays must be same length as WL.
var CMF = {
  x:[0.0014,0.0022,0.0042,0.0076,0.0143,0.0232,0.0435,0.0776,0.1344,0.2148,0.2839,0.3285,0.3483,0.3481,0.3362,0.3187,0.2908,0.2511,0.1954,0.1421,0.0956,0.05795,0.032,0.0147,0.0049,0.0024,0.0093,0.0291,0.06327,0.1096,0.1655,0.2257,0.2904,0.3597,0.43345,0.51205,0.5945],
  y:[0.0000,0.0001,0.0001,0.0002,0.0004,0.0006,0.0012,0.0022,0.0040,0.0073,0.0116,0.01684,0.023,0.0298,0.038,0.048,0.06,0.0739,0.09098,0.1126,0.13902,0.1693,0.20802,0.2586,0.323,0.4073,0.503,0.6082,0.71,0.7932,0.862,0.91485,0.954,0.9803,0.99495,1.0,0.995]
  ,z:[0.0065,0.0105,0.0201,0.0362,0.0679,0.1102,0.2074,0.3713,0.6456,1.0391,1.3856,1.62296,1.74706,1.7826,1.77211,1.7441,1.6692,1.5281,1.28764,1.0419,0.81295,0.6162,0.46518,0.3533,0.272,0.2123,0.1582,0.1117,0.07825,0.05725,0.04216,0.02984,0.0203,0.0134,0.00875,0.00575,0.0039]
};
var SPD_D50 = [0.0341,0.3601,0.6862,1.012,1.338,1.664,1.99,2.316,2.642,2.968,3.294,3.62,3.946,4.272,4.598,4.924,5.25,5.576,5.902,6.228,6.554,6.88,7.206,7.532,7.858,8.184,8.51,8.836,9.162,9.488,9.814,10.14,10.466,10.792,11.118,11.444];
// normalise SPD to unity Y when used

function dot(a,b){ var s=0; for(var i=0;i<a.length;i++) s += a[i]*b[i]; return s; }

function spectrumToXyz(R){
  // Compute XYZ under D50/2°. Assume R sampled at WL, multiply by illuminant.
  var k = 100 / dot(CMF.y, SPD_D50);
  var RX = 0, RY = 0, RZ = 0;
  for (var i=0;i<WL.length;i++){
    var Ii = SPD_D50[i]; var Ri = clamp(R[i], 0, 1);
    RX += CMF.x[i]*Ii*Ri; RY += CMF.y[i]*Ii*Ri; RZ += CMF.z[i]*Ii*Ri;
  }
  return {X:k*RX, Y:k*RY, Z:k*RZ};
}

function xyzToLabD50(X,Y,Z){
  // D50 white (from 2° CIE standard):
  var Xn=96.4212, Yn=100.0, Zn=82.5188;
  function f(t){ var d=6/29; return t>(d*d*d)? Math.cbrt(t) : (t/(3*d*d)+4/29); }
  var fx=f(X/Xn), fy=f(Y/Yn), fz=f(Z/Zn);
  return { L:116*fy-16, a:500*(fx-fy), b:200*(fy-fz) };
}

function spectrumToLab(R){ var xyz=spectrumToXyz(R); return xyzToLabD50(xyz.X, xyz.Y, xyz.Z); }

// sRGB preview (approx from Lab)
function labToXyzD65(L,a,b){ var Yn=1, Xn=0.95047, Zn=1.08883; var fy=(L+16)/116; var fx=function(f){ return f>0.206893?f*f*f:(f-16/116)/7.787; }; return { X: fx((a/500)+fy)*Xn, Y: fx(fy)*Yn, Z: fx(fy-(b/200))*Zn }; }
function labToSrgb(L,a,b){ var xyz = labToXyzD65(L,a,b); var X=xyz.X, Y=xyz.Y, Z=xyz.Z; var r =  3.2406*X -1.5372*Y -0.4986*Z; var g = -0.9689*X +1.8758*Y +0.0415*Z; var b2= 0.0557*X -0.2040*Y +1.0570*Z; function enc(v){ return v<=0.0031308?12.92*v:1.055*Math.pow(v,1/2.4)-0.055; } return {r:clamp(Math.round(enc(r)*255),0,255), g:clamp(Math.round(enc(g)*255),0,255), b:clamp(Math.round(enc(b2)*255),0,255)}; }

// ΔE2000
function deltaE2000(c1,c2){ var L1=c1.L,a1=c1.a,b1=c1.b, L2=c2.L,a2=c2.a,b2=c2.b; var avgLp=(L1+L2)/2; var C1=Math.hypot(a1,b1), C2=Math.hypot(a2,b2), avgC=(C1+C2)/2; var G=0.5*(1-Math.sqrt(Math.pow(avgC,7)/(Math.pow(avgC,7)+Math.pow(25,7)))); var a1p=(1+G)*a1, a2p=(1+G)*a2; var C1p=Math.hypot(a1p,b1), C2p=Math.hypot(a2p,b2); function hp(x,y){ var h=Math.atan2(y,x)*180/Math.PI; return h>=0?h:h+360; } var h1p=(C1p<1e-7?0:hp(a1p,b1)), h2p=(C2p<1e-7?0:hp(a2p,b2)); var dLp=L2-L1; var dCp=C2p-C1p; var dhp=h2p-h1p; if (C1p*C2p===0) dhp=0; else if (dhp>180) dhp-=360; else if (dhp<-180) dhp+=360; var dHp=2*Math.sqrt(C1p*C2p)*Math.sin((dhp*Math.PI/180)/2); var avgLp2=(avgLp-50)*(avgLp-50); var Sl=1+0.015*avgLp2/Math.sqrt(20+avgLp2); var Sc=1+0.045*avgC; var avgHp=(Math.abs(h1p-h2p)>180)? (h1p+h2p+360)/2 : (h1p+h2p)/2; var T=1-0.17*Math.cos((avgHp-30)*Math.PI/180)+0.24*Math.cos(2*avgHp*Math.PI/180)+0.32*Math.cos(3*avgHp*Math.PI/180+6*Math.PI/180)-0.20*Math.cos(4*avgHp*Math.PI/180-63*Math.PI/180); var Sh=1+0.015*avgC*T; var Rc=2*Math.sqrt(Math.pow(avgC,7)/(Math.pow(avgC,7)+Math.pow(25,7))); var Rt=-Rc*Math.sin(2*(30*Math.exp(-Math.pow((avgHp-275)/25,2)))*Math.PI/180); return Math.sqrt((dLp/Sl)*(dLp/Sl)+(dCp/Sc)*(dCp/Sc)+(dHp/Sh)*(dHp/Sh)+Rt*(dCp/Sc)*(dHp/Sh)); }

// ====== Data ======
var COLOURS=[], FORMULAS={}, ASSORTMENT={}, IFSX={};
var FORMULAS_NORM={}, COLOUR_TO_FORMULA={};
var CODE_NAME={
  "DC21-001":"Extender","DC21-002":"Extender","DC21-901":"White","DC21-802":"Black",
  "DC21-304":"Yellow","DC21-201":"Orange","DC21-402":"Green","DC21-604":"Violet","DC21-501":"Process Blue",
  "DC21-101":"Bright Red","DC21-102":"Rubine","DC21-114":"Rhodamine"
};

function normaliseName(s){ return String(s||'').trim().toUpperCase().replace(/\s+/g,' '); }
function extractPmsNumber(name){ if(!name) return null; var m=String(name).toUpperCase().match(/PANTONE\s*([0-9A-Z]+(?:[\- ]?[0-9A-Z]+)*)/); return m? m[1].replace(/\s+/g,'').replace(/^\-/,''): null; }

function buildFormulaIndex(){ var rows=[]; FORMULAS_NORM={}; COLOUR_TO_FORMULA={}; if(Array.isArray(FORMULAS)){ rows.push.apply(rows, FORMULAS); } else if (FORMULAS && typeof FORMULAS==='object'){ Object.keys(FORMULAS).forEach(function(k){ if(Array.isArray(FORMULAS[k])) rows.push.apply(rows, FORMULAS[k]); else if (FORMULAS[k] && typeof FORMULAS[k]==='object' && Array.isArray(FORMULAS[k].rows)) rows.push.apply(rows, FORMULAS[k].rows); }); } var byColour=new Map(); rows.forEach(function(r){ var cname=r.Colour||r.colour||r.Color||r.color||r.NAME||r.Name; if(!cname) return; var items=[]; for(var i=1;i<=12;i++){ var ink=r['Ingredient '+i]||r['Ink '+i]||r['INGREDIENT '+i]||r['ingredient '+i]; if(!ink) continue; var pct=r['%'+i]||r[i+'%']||r['% '+i]||r['Percent '+i]||r['Percent'+i]||r['%']||''; items.push({ink:ink, percent:pct}); } var arr=byColour.get(cname)||[]; arr.push.apply(arr, items); byColour.set(cname, arr); FORMULAS_NORM[normaliseName(cname)]=arr; }); (COLOURS||[]).forEach(function(c){ var name=c.name||c.Colour||c.color||''; var norm=normaliseName(name); if(FORMULAS_NORM[norm]) { COLOUR_TO_FORMULA[name]=norm; return; } var p=extractPmsNumber(name); if(p){ for (var key in FORMULAS_NORM){ if((extractPmsNumber(key)||'')===p){ COLOUR_TO_FORMULA[name]=normaliseName(key); break; } } } }); }

// ===== Spectral KM core =====
// From IFSX: per-ink reflectance R∞(λ) at full strength (approx), and maybe a paper ref spectrum.
var INK_RINF = {}; // code -> R∞[λ]
var PAPER_R = null; // spectrum of paper (if present), not strictly required for R∞ mixer

// Robust loader for IFSX structure ({colorants:[{name,R}]}, {refs:{name:{R}}})
function loadIfsx2(data){
  IFSX = data || {};
  INK_RINF = {};
  PAPER_R = null;
  if (IFSX && IFSX.refs){
    var keys = Object.keys(IFSX.refs);
    if (keys.length){
      var ref = IFSX.refs[keys[0]];
      if (ref && Array.isArray(ref.R)) PAPER_R = ref.R.slice();
    }
  }
  if (IFSX && Array.isArray(IFSX.colorants)){
    IFSX.colorants.forEach(function(c){
      if (!c || !Array.isArray(c.R)) return;
      var nm = String(c.name || '');
      var codeGuess = nm.toUpperCase().split(' ')[0];
      var code = (codeGuess.indexOf('DC')===0 && codeGuess.indexOf('-')>0) ? codeGuess : nm.toUpperCase();
      INK_RINF[code] = c.R.slice();
      var friendly = nm.substring(code.length).trim();
      if (friendly && !CODE_NAME[code]) CODE_NAME[code] = friendly;
    });
  }
}

function loadIfsx(data){
  IFSX = data || {};
  // refs: pick the first as paper (your file labelled PP60 Top Black acts like white)
  if (IFSX && IFSX.refs){ var keys=Object.keys(IFSX.refs); if (keys.length){ PAPER_R = IFSX.refs[keys[0]]; } }
  // inks:
  if (IFSX && IFSX.inks){
    Object.keys(IFSX.inks).forEach(function(k){
      var entry = IFSX.inks[k];
      if (entry && Array.isArray(entry.R) && entry.R.length===WL.length){ INK_RINF[k] = entry.R.slice(); }
    });
  }
}

// Convert R∞ to q = K/S via KM infinite-layer formula: q = (1-R)^2 / (2R)
function RinfToQ(R){ var q=new Array(R.length); for (var i=0;i<R.length;i++){ var Ri=clamp(R[i], 1e-6, 0.999999); q[i] = ((1-Ri)*(1-Ri))/(2*Ri); } return q; }

var INK_Q = {}; // code -> q[λ]
function buildInkQ(){ INK_Q={}; Object.keys(INK_RINF).forEach(function(code){ var R=INK_RINF[code]; if(Array.isArray(R)&&R.length===WL.length){ INK_Q[code]=RinfToQ(R); } }); }; Object.keys(INK_RINF).forEach(function(code){ INK_Q[code] = RinfToQ(INK_RINF[code]); }); };

// We parameterise each ink i by a scalar strength s_i so that its contribution to S is s_i, to K is s_i*q_i.
// Extender (clear) has q≈0 and its own scattering scalar s_ext. We will fit s_i and s_ext to ladder data.
var STRENGTH = {}; // code -> s_i
var S_EXT = 1;     // global extender scattering scalar (DC21-002)

// Predict R∞ of a mix given fractions (including extender) — infinite-thickness approximation
function mixRinfFromFractions(codes, fracs){
  var s = sum(fracs); if (!s) return new Array(WL.length).fill(1);
  // normalise
  var f = fracs.map(function(x){ return x/s; });
  // Build K and S
  var K = new Array(WL.length).fill(0), S = new Array(WL.length).fill(0);
  for (var i=0;i<codes.length;i++){
    var code=codes[i], fi=f[i];
    if (!INK_Q[code]) continue;
    var si = STRENGTH[code] || 1;
    var qi = INK_Q[code];
    for (var j=0;j<WL.length;j++){ K[j] += fi * si * qi[j]; S[j] += fi * si; }
  }
  // Add extender scattering from any extender fraction
  var extFrac=0; for (var k=0;k<codes.length;k++){ if (/\bDC21-002\b|\bDC21-001\b|\bEXTENDER\b/i.test(codes[k])) extFrac += f[k]; }
  if (extFrac>0){ for (var j2=0;j2<WL.length;j2++){ S[j2] += extFrac * S_EXT; } }
  // Compute q_mix = K/S and R∞_mix
  var R = new Array(WL.length);
  for (var j3=0;j3<WL.length;j3++){
    var q = (S[j3]>1e-12)? K[j3]/S[j3] : 0;
    var A = 1 + q; var B = Math.sqrt(Math.max(0, A*A - 1));
    R[j3] = clamp(A - B, 0, 1);
  }
  return R;
}

// ===== Use ladder (assortment) to fit strengths =====
var LADDER = {}; // code -> [{conc,L,a,b}, ...] (white ladder)

function loadAssortmentIntoLadders(){
  LADDER = {};
  for (var code in ASSORTMENT){
    var entry = ASSORTMENT[code]; if (!entry) continue;
    var arr = (entry.white||[]).map(function(s){ return { conc: +s.conc || +s.Conc || +s.concentration || +s.Percent || +s.pct || 0, L:+s.L, a:+s.a, b:+s.b }; })
      .filter(function(s){ return s.conc>=0 && isFinite(s.L) && isFinite(s.a) && isFinite(s.b); })
      .sort(function(a,b){ return a.conc-b.conc; });
    if (arr.length>=2) LADDER[code] = arr;
  }
}

function labDeltaE(a,b){ return deltaE2000(a,b); }

function fitStrengths(){
  // Initial guesses
  S_EXT = 1.0;
  Object.keys(INK_Q).forEach(function(code){ STRENGTH[code] = 1.0; });
  var exCode = findExtenderCode(); if (exCode && !INK_Q[exCode]){ // extender may not have its own spectrum; ok
    STRENGTH[exCode] = 0.1; // unused
  }

  // Collect training samples from ladders: for each (code, conc c) build a synthetic mix [code:c, extender:1-c] and compare Lab
  var samples=[]; var EX = findExtenderCode();
  Object.keys(LADDER).forEach(function(code){
    var arr=LADDER[code];
    arr.forEach(function(s){
      var c = clamp((+s.conc||0)/100, 0, 1);
      var mixCodes=[code]; var mixFr=[c];
      if (EX){ mixCodes.push(EX); mixFr.push(1-c); }
      var targetLab = {L:+s.L, a:+s.a, b:+s.b};
      samples.push({codes:mixCodes, fracs:mixFr, lab:targetLab});
    });
  });

  // Coordinate descent on strengths to minimise total ΔE
  function totalErr(){ var e=0; for (var i=0;i<samples.length;i++){ var R=mixRinfFromFractions(samples[i].codes, samples[i].fracs); var Lab=spectrumToLab(R); e += labDeltaE(Lab, samples[i].lab); } return e / Math.max(1, samples.length); }

  var bestErr = totalErr();
  var keys = Object.keys(INK_Q);
  var MAX_IT=200; var step=0.25;
  for (var it=0; it<MAX_IT; it++){
    var improved=false;
    // tweak S_EXT
    for (var sgn=-1; sgn<=1; sgn+=2){
      var old=S_EXT; S_EXT = Math.max(0.01, S_EXT * (1 + sgn*step));
      var err=totalErr(); if (err < bestErr){ bestErr=err; improved=true; } else { S_EXT=old; }
    }
    // tweak each ink strength
    for (var k=0;k<keys.length;k++){
      var code=keys[k];
      for (var sgn2=-1; sgn2<=1; sgn2+=2){
        var prev=STRENGTH[code]; STRENGTH[code] = Math.max(0.01, prev * (1 + sgn2*step));
        var err2=totalErr(); if (err2 < bestErr){ bestErr=err2; improved=true; } else { STRENGTH[code]=prev; }
      }
    }
    if (!improved){ step*=0.6; if (step<0.01) break; }
  }
  return bestErr;
}

function findExtenderCode(){ var ex=null; Object.keys(INK_Q).some(function(code){ if (/\bDC21-002\b|\bDC21-001\b|\bEXTENDER\b/i.test(code)){ ex=code; return true; } return false; }); return ex; }

// ===== Suggestion engine (uses spectral KM model) =====
function getCandidateCodes(){ return Object.keys(INK_Q).sort(); }

function predictLabForMix(codes, fracs){ var R=mixRinfFromFractions(codes, fracs); return spectrumToLab(R); }

function suggestRecipeSpectral(target, maxInks, mode){
  var codes=getCandidateCodes(); if(!codes.length) throw new Error('No spectral ink data');
  var EX=findExtenderCode();
  // Rank by hue proximity (use full-strength R∞ -> Lab to compare)
  var ranked = codes.map(function(c){ var Lab=spectrumToLab(INK_RINF[c]); return {code:c, de:deltaE2000(Lab,target)}; })
                    .sort(function(a,b){return a.de-b.de;}).map(function(o){return o.code;});
  var pool = ranked.slice(0, mode==='full'? Math.max(40, maxInks+20): Math.max(12, maxInks+6));
  if (EX && pool.indexOf(EX)<0) pool.unshift(EX);

  function normalise(fr){ var s=sum(fr); if(s<=0){ var v=1/fr.length; for (var i=0;i<fr.length;i++) fr[i]=v; } else { for (var i2=0;i2<fr.length;i2++) fr[i2]/=s; } }
  function score(active, fr){ var lab=predictLabForMix(active, fr); return {lab:lab, de:deltaE2000(lab,target)}; }

  function localRefine(active, fr){
    normalise(fr);
    var best=score(active, fr);
    var step=0.25, MIN_STEP=0.0002, MAX_IT=(mode==='full'?20000:5000);
    var it=0, improved=true;
    function tryAdjust(fr, i, delta){ var sOthers=1-fr[i]; if(sOthers<=0) return false; var move=clamp(delta, -fr[i], +sOthers); if(move===0) return false; for (var k=0;k<fr.length;k++) if(k!==i) fr[k]-=move*(fr[k]/sOthers); fr[i]+=move; return true; }
    while(step>=MIN_STEP && it<MAX_IT){ it++; improved=false;
      for (var i=0;i<fr.length;i++){
        for (var dir=-1; dir<=1; dir+=2){
          var prev=fr.slice(); if(!tryAdjust(fr,i,dir*step)) continue; var cur=score(active, fr);
          if (cur.de + 1e-6 < best.de){ best=cur; improved=true; } else { fr=prev; }
        }
      }
      if(!improved){ var r=Math.floor(Math.random()*fr.length); tryAdjust(fr,r,(Math.random()*2-1)*step*0.1); step*=0.5; }
    }
    return {codes:active.slice(), fracs:fr.slice(), lab:best.lab, dE:best.de};
  }

  function anneal(active, fr){
    normalise(fr);
    var best=score(active, fr), bestFr=fr.slice(); var cur=best, curFr=fr.slice();
    var T0=(mode==='full'?0.25:0.1), Tend=(mode==='full'?0.0005:0.002), steps=(mode==='full'?5000:200);
    for (var s=0;s<steps;s++){
      var T=T0*Math.pow(Tend/T0, s/(steps-1));
      var i=Math.floor(Math.random()*fr.length); var j=Math.floor(Math.random()*fr.length); if(i===j) j=(j+1)%fr.length;
      var prev=curFr.slice(); var amt=(Math.random()*2-1)*(mode==='full'?0.12:0.06);
      var take=clamp(amt, -curFr[i], curFr[j]); curFr[i]+=take; curFr[j]-=take; normalise(curFr);
      var prop=score(active, curFr); var d=prop.de-cur.de;
      if (d<0 || Math.exp(-d/Math.max(1e-9,T))>Math.random()){ cur=prop; if(prop.de<best.de){ best=prop; bestFr=curFr.slice(); } }
      else { curFr=prev; }
    }
    return {codes:active.slice(), fracs:bestFr.slice(), lab:best.lab, dE:best.de};
  }

  var globalBest=null; var comboSets=[];
  function pushCombo(arr){ var set=new Set(), ded=arr.filter(function(c){ if(set.has(c)) return false; set.add(c); return true; }); if(ded.length>=2) comboSets.push(ded); }
  function pickActive(){ var base=[pool[0]]; if(EX) base.unshift(EX); for (var i=1;i<pool.length && base.length<maxInks;i++) if(base.indexOf(pool[i])<0) base.push(pool[i]); return base; }
  function sampleCombos(){ pushCombo(pickActive()); if(mode==='full'){ var tries=500; for (var t=0;t<tries;t++){ var want=Math.min(maxInks, 2+Math.floor(Math.random()*Math.min(5,maxInks-1))); var combo=[]; if(EX) combo.push(EX); while(combo.length<want){ var c=pool[Math.floor(Math.random()*pool.length)]; if(combo.indexOf(c)<0) combo.push(c); } pushCombo(combo); } } }
  sampleCombos();

  var NUM_SEEDS=(mode==='full'?320:16);
  for (var cs=0; cs<comboSets.length; cs++){
    var active=comboSets[cs];
    var seeds=(mode==='full'? Math.max((NUM_SEEDS/Math.max(1,comboSets.length/3))|0,24):NUM_SEEDS);
    for (var s2=0; s2<seeds; s2++){
      var fr=new Array(active.length); for (var i0=0;i0<fr.length;i0++) fr[i0]=Math.random()+1e-6; var S0=sum(fr); for (var i1=0;i1<fr.length;i1++) fr[i1]/=S0;
      // encourage extender for light targets
      if (EX){ var ti=active.indexOf(EX); if(ti>=0){ fr[ti]=Math.max(fr[ti],0.3); var S1=sum(fr); for (var j=0;j<fr.length;j++) fr[j]/=S1; } }
      var A=anneal(active, fr); var L=localRefine(A.codes, A.fracs);
      var keptC=[], keptF=[]; for (var k=0;k<L.codes.length;k++){ if(L.fracs[k]>=0.01){ keptC.push(L.codes[k]); keptF.push(L.fracs[k]); } }
      if(keptC.length>0){ var S3=sum(keptF); for (var m=0;m<keptF.length;m++) keptF[m]/=S3; L=localRefine(keptC, keptF); }
      if(!globalBest || L.dE + 1e-6 < globalBest.dE) globalBest=L;
    }
  }
  if(!globalBest) throw new Error('Optimisation failed');
  return globalBest;
}

// ===== UI helpers =====
function updateTargetEcho(){ var L=parseFloat($('#L').value), a=parseFloat($('#a').value), b=parseFloat($('#b').value); if([L,a,b].some(function(v){return Number.isNaN(v);})){ $('#targetEcho').textContent='Target: –'; $('#targetSwatch').style.background='#0000'; return; } $('#targetEcho').textContent='Target: L '+L.toFixed(2)+' a '+a.toFixed(2)+' b '+b.toFixed(2); var rgb=labToSrgb(L,a,b); $('#targetSwatch').style.background='rgb('+rgb.r+','+rgb.g+','+rgb.b+')'; }
function getTargetLab(){ var L=parseFloat($('#L').value), a=parseFloat($('#a').value), b=parseFloat($('#b').value); if([L,a,b].some(Number.isNaN)) return null; return {L:L,a:a,b:b}; }

function findClosest(){ var target=getTargetLab(); if(!target){ alert('Enter a valid colour first.'); return; } var rows=COLOURS.map(function(c){ return { raw:c, name:c.name||c.Colour||c.color||'—', L:c.L,a:c.a,b:c.b, de:deltaE2000({L:c.L,a:c.a,b:c.b}, target) }; }).sort(function(a,b){return a.de-b.de;}).slice(0,8); var tbody=$('#resultsTbody'); tbody.innerHTML=''; rows.forEach(function(r){ var tr=document.createElement('tr'); tr.className='result-row'; var rgb=labToSrgb(r.L,r.a,r.b); tr.innerHTML='<td>'+r.name+'</td><td><div class="swatch" style="background: rgb('+rgb.r+','+rgb.g+','+rgb.b+')"></div></td><td>'+r.L.toFixed(2)+'</td><td>'+r.a.toFixed(2)+'</td><td>'+r.b.toFixed(2)+'</td><td>'+r.de.toFixed(2)+'</td>'; tr.addEventListener('click', function(){ showFormulaFor(r.name); }); tbody.appendChild(tr); }); }
function findByPms(){ var qRaw=($('#pms').value||'').trim().toUpperCase(); if(!qRaw){ alert('Enter a PMS number'); return; } var q=qRaw.replace(/^PANTONE\s*/,''); var hits=COLOURS.filter(function(c){ var p=extractPmsNumber(c.name||c.Colour||c.color||''); return p && p.includes(q);}); var tbody=$('#resultsTbody'); tbody.innerHTML=''; if(!hits.length){ alert('No PMS match found'); return; } hits.slice(0,8).forEach(function(c){ var rgb=labToSrgb(c.L,c.a,c.b); var tr=document.createElement('tr'); tr.className='result-row'; tr.innerHTML='<td>'+(c.name||c.Colour||c.color||'—')+'</td><td><div class="swatch" style="background: rgb('+rgb.r+','+rgb.g+','+rgb.b+')"></div></td><td>'+(+c.L).toFixed(2)+'</td><td>'+(+c.a).toFixed(2)+'</td><td>'+(+c.b).toFixed(2)+'</td><td>—</td>'; tr.addEventListener('click', function(){ $('#L').value=c.L; $('#a').value=c.a; $('#b').value=c.b; updateTargetEcho(); findClosest(); showFormulaFor(c.name||c.Colour||c.color||''); }); tbody.appendChild(tr); }); }
function showFormulaFor(colourName){ var panel=$('#formulaPanel'); var list=null; var bound=COLOUR_TO_FORMULA[colourName]; if(bound) list=FORMULAS_NORM[bound]; if(!list) list=FORMULAS_NORM[normaliseName(colourName)]; if(!list){ var want=extractPmsNumber(colourName); if(want){ for (var key in FORMULAS_NORM){ if((extractPmsNumber(key)||'')===want){ list=FORMULAS_NORM[key]; break; } } } } if(!list||!list.length){ panel.style.display='none'; return; } var html='<h2>Existing Formula: '+colourName+'</h2><div class="formula-grid">'; list.forEach(function(item){ var name=item.ink||item.Ink||'Ink'; var pct=item.percent!==''? (item.percent+'%') : ''; html+='<div class="fg-ink">'+name+'</div><div class="fg-pct">'+pct+'</div>'; }); html+='</div>'; panel.innerHTML=html; panel.style.display='block'; }

function suggestFormula(){
  try{
    var target=getTargetLab(); if(!target){ alert('Enter a valid colour first.'); return; }
    var mode=$('#mode').value||'fast'; var maxInks=Math.max(2, Math.min(8, parseInt($('#maxInks').value||5,10)));
    $('#predictMsg').textContent= mode==='full' ? 'Full Send… this might take a bit' : 'Mixing…';
    var out=suggestRecipeSpectral(target, maxInks, mode);
    var rgb=labToSrgb(out.lab.L,out.lab.a,out.lab.b);
    var total=sum(out.fracs)||1; var merged=out.codes.map(function(code,i){ return {code:code, pct:(out.fracs[i]/total)*100}; }).sort(function(a,b){return b.pct-a.pct;});
    var html=''
      + '<div class="row2">'
      +   '<div>'
      +     '<div class="pill">Spectral KM ('+(mode==='full'?'Full Send':'Production')+')</div>'
      +     '<div class="swatch" style="background: rgb('+rgb.r+','+rgb.g+','+rgb.b+'); margin:6px 0 8px"></div>'
      +     '<div class="muted">Predicted: L '+out.lab.L.toFixed(2)+' a '+out.lab.a.toFixed(2)+' b '+out.lab.b.toFixed(2)+' · ΔE00: <strong>'+out.dE.toFixed(2)+'</strong></div>'
      +   '</div>'
      +   '<div style="text-align:right">'
      +     '<button class="btn" onclick="document.querySelector(\'#suggestedFormula\').style.display=\'none\'">Close</button>'
      +   '</div>'
      + '</div>';
    html += '<div class="formula-grid">' + merged.map(function(p){ return '<div class="fg-ink">'+p.code+' — '+(CODE_NAME[p.code]||p.code)+'</div><div class="fg-pct">'+p.pct.toFixed(1)+'%</div>'; }).join('') + '</div>';
    var box=$('#suggestedFormula'); if(box){ box.innerHTML=html; box.style.display='block'; }
    $('#predictMsg').textContent='';
  }catch(err){ console.error(err); $('#predictMsg').textContent='Error: '+err.message; }
}

// ===== Load JSON and boot =====
Promise.all([
  fetch('colours.json').then(function(r){return r.json();}),
  fetch('DC_Formulas.json').then(function(r){return r.json();}),
  fetch('assortment_colour_data.json').then(function(r){return r.json();}),
  fetch('ifsx_reflectance_abs.json').then(function(r){return r.json();})
]).then(function(tuple){
  COLOURS=tuple[0]; FORMULAS=tuple[1]; ASSORTMENT=tuple[2]; loadAssortmentIntoLadders();
  IFSX=tuple[3]; loadIfsx2(IFSX); buildInkQ(); console.log('[IFSX] inks:', Object.keys(INK_RINF).length, 'q-curves:', Object.keys(INK_Q).length); $('#countLabel').textContent=COLOURS.length; buildFormulaIndex();
  var fitErr = fitStrengths(); console.log('Fitted strengths avg ΔE to ladders:', fitErr.toFixed(3));
  runTests();
}).catch(function(err){ alert('Error loading JSON: '+err); });

// Wire UI
$('#findBtn').addEventListener('click', findClosest);
$('#clearBtn').addEventListener('click', function(){ $('#L').value=''; $('#a').value=''; $('#b').value=''; updateTargetEcho(); $('#resultsTbody').innerHTML=''; $('#formulaPanel').style.display='none'; $('#suggestedFormula').style.display='none'; });
$('#suggestBtn').addEventListener('click', suggestFormula);
$('#pmsBtn').addEventListener('click', findByPms);
['L','a','b'].forEach(function(id){ $('#'+id).addEventListener('input', updateTargetEcho); });

updateTargetEcho();

// ===== Sanity tests =====
function approxEq(a,b,eps){ return Math.abs(a-b) <= (eps||1e-6); }
function runTests(){
  try{
    console.assert(approxEq(deltaE2000({L:50,a:0,b:0},{L:50,a:0,b:0}),0),'DE00 identity');
    var anyInk = Object.keys(INK_RINF)[0]; if (anyInk){ var Lab=spectrumToLab(INK_RINF[anyInk]); console.log('[Test] anyInk Lab', anyInk, Lab); }
    // simple spectral mix sanity
    var ex=findExtenderCode(); var keys=getCandidateCodes().slice(0,2);
    if (keys.length>=1){ var R=mixRinfFromFractions([keys[0], ex].filter(Boolean), [0.3,0.7].filter(Boolean)); var L=spectrumToLab(R); console.assert(isFinite(L.L), 'Spectral mix gives Lab'); }
    console.log('[Tests] OK');
  }catch(e){ console.warn('[Tests] exception', e); }
}

})();
</script>
</body>
</html>
